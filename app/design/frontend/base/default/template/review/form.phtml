<?php
/**
 * Maho
 *
 * @package     base_default
 * @copyright   Copyright (c) 2006-2020 Magento, Inc. (https://magento.com)
 * @copyright   Copyright (c) 2021-2025 The OpenMage Contributors (https://openmage.org)
 * @copyright   Copyright (c) 2024-2026 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/** @var Mage_Review_Block_Form $this */
?>
<dialog id="review-dialog">
    <div class="dialog__header">
        <h2><?= $this->__("You're reviewing:") ?> <?= $this->escapeHtml($this->getProductInfo()->getName()) ?></h2>
        <button type="button" class="dialog__close" onclick="this.closest('dialog').close()" title="<?= $this->quoteEscape($this->__('Close')) ?>">&times;</button>
    </div>
    <div class="dialog__content">
        <?php if ($this->getAllowWriteReviewFlag()): ?>
        <form action="<?= $this->getAction() ?>" method="post" id="review-form">
            <?= $this->getBlockHtml('formkey') ?>
            <?= $this->getChildHtml('form_fields_before') ?>

            <div class="fieldset">
                <?php if ($this->getRatings() && $this->getRatings()->getSize()): ?>
                    <div class="review-dialog__ratings" id="product-review-table">
                        <?php foreach ($this->getRatings() as $_rating): ?>
                            <div class="review-dialog__rating-row">
                                <span class="review-dialog__rating-label"><?= $this->escapeHtml($_rating->getRatingCode()) ?></span>
                                <div class="star-rating">
                                <?php foreach (array_reverse($_rating->getOptions()) as $_option): ?>
                                    <input class="star-rating__value" type="radio" id="<?= $this->escapeHtml($_rating->getRatingCode()) ?>_<?= $_option->getValue() ?>" value="<?= $_option->getId() ?>" name="ratings[<?= $_rating->getId() ?>]" />
                                    <label for="<?= $this->escapeHtml($_rating->getRatingCode()) ?>_<?= $_option->getValue() ?>" class="star-rating__label" title="<?= $_option->getLabel() ?>"><?= $_option->getLabel() ?></label>
                                <?php endforeach ?>
                                </div>
                            </div>
                        <?php endforeach ?>
                    </div>
                    <input type="hidden" name="validate_rating" class="validate-rating" value="" />
                <?php endif ?>

                <div class="review-dialog__fields">
                    <div class="review-dialog__field">
                        <label for="summary_field"><?= $this->__('Summary') ?></label>
                        <input type="text" name="title" id="summary_field" class="required-entry" value="<?= $this->escapeHtml($data->getTitle()) ?>" />
                    </div>
                    <div class="review-dialog__field">
                        <label for="review_field"><?= $this->__('Review') ?></label>
                        <textarea name="detail" id="review_field" rows="4" class="required-entry"><?= $this->escapeHtml($data->getDetail()) ?></textarea>
                    </div>
                    <div class="review-dialog__field">
                        <label for="nickname_field"><?= $this->__('Nickname') ?></label>
                        <input type="text" name="nickname" id="nickname_field" class="required-entry" value="<?= $this->escapeHtml($data->getNickname()) ?>" />
                    </div>
                </div>
            </div>
            <div class="dialog__actions">
                <button type="button" class="button" onclick="this.closest('dialog').close()"><?= $this->__('Cancel') ?></button>
                <button type="submit" class="button"><?= $this->__('Submit Review') ?></button>
            </div>
        </form>
        <script>
            new VarienForm('review-form');
            Validation.add('validate-rating', '<?= $this->jsQuoteEscape($this->__('Please select a rating for each category')) ?>', function() {
                const ratingRows = document.querySelectorAll('#product-review-table .review-dialog__rating-row');
                for (const row of ratingRows) {
                    if (!row.querySelector('input[type="radio"]:checked')) {
                        return false;
                    }
                }
                return true;
            });
        </script>
        <?php else: ?>
        <p class="review-dialog__login-required">
            <?= $this->__('Only registered users can write reviews. Please, <a href="%s">log in</a> or <a href="%s">register</a>', $this->getLoginLink(), Mage::helper('customer')->getRegisterUrl()) ?>
        </p>
        <?php endif ?>
    </div>
</dialog>
