<?php
/**
 * Maho
 *
 * @category   design
 * @package    base_default
 * @copyright  Copyright (c) 2025-2026 Maho (https://mahocommerce.com)
 * @license    https://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */

/** @var Mage_Core_Block_Template $this */
$quote = $this->getQuote();
if (!$quote) {
    $quote = Mage::getSingleton('checkout/session')->getQuote();
}

$giftcardCodes = $quote->getGiftcardCodes();
if ($giftcardCodes):
    $codes = json_decode($giftcardCodes, true);
    if ($codes && count($codes) > 0):
?>
<div class="applied-giftcards-section mt-4">
    <h5 class="font-semibold text-sm mb-2"><?php echo $this->__('Applied Gift Cards') ?>:</h5>
    <div class="space-y-2">
        <?php foreach ($codes as $code => $amount): ?>
            <?php
                // Display partial code for security
                $displayCode = $code;
                if (strlen($code) > 10) {
                    $displayCode = substr($code, 0, 4) . '...' . substr($code, -4);
                }
            ?>
            <div class="flex justify-between items-center p-2 bg-base-200 rounded">
                <div class="flex-1">
                    <span class="text-sm font-medium"><?php echo $this->escapeHtml($displayCode) ?></span>
                    <span class="text-sm text-success ml-2">-<?php echo Mage::helper('core')->currency($amount, true, false) ?></span>
                </div>
                <button type="button"
                        class="btn btn-ghost btn-xs text-error js-remove-giftcard"
                        data-code="<?php echo $this->escapeHtml($code) ?>"
                        title="<?php echo $this->__('Remove Gift Card') ?>">
                    <i class="fas fa-times"></i> <?php echo $this->__('Remove') ?>
                </button>
            </div>
        <?php endforeach; ?>
    </div>
</div>

<script type="module">
const confirmMessage = <?php echo Mage::helper('core')->jsonEncode($this->__('Are you sure you want to remove this gift card?')) ?>;

document.querySelectorAll('.js-remove-giftcard').forEach(button => {
    button.addEventListener('click', function() {
        const code = this.dataset.code;
        if (confirm(confirmMessage)) {
            if (window.ModernFirecheckout) {
                window.ModernFirecheckout.updateCheckoutSection(['checkout-giftcard-load', 'review'], {
                    'giftcard_code': code,
                    'remove_giftcard': '1'
                });
            }
        }
    });
});
</script>
<?php
    endif;
endif;
?>
