<?php
/**
 * Maho
 *
 * @category   design
 * @package    base_default
 * @copyright  Copyright (c) 2025-2026 Maho (https://mahocommerce.com)
 * @license    https://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */

/** @var Maho_Giftcard_Block_Checkout_Payment_Giftcard $this */
$appliedGiftcards = $this->getAppliedGiftcards();
$canApply = $this->canApplyGiftcard();
$isFullyCovered = $this->isFullyCovered();
$amountDue = $this->getAmountDue();
$totalGiftcardAmount = $this->getTotalGiftcardAmount();
$subtotalBeforeGiftcard = $this->getSubtotalBeforeGiftcard();
?>

<?php if ($canApply): ?>
<div id="checkout-giftcard-container" class="checkout-giftcard-section" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
    <div class="checkout-giftcard-header" style="margin-bottom: 15px;">
        <h3 style="margin: 0 0 5px; font-size: 14px; font-weight: 600;">
            <?php echo $this->__('Gift Card') ?>
        </h3>
        <p style="margin: 0; font-size: 12px; color: #666;">
            <?php echo $this->__('Have a gift card? Apply it here to reduce your payment amount.') ?>
        </p>
    </div>

    <!-- Applied Gift Cards -->
    <div id="applied-giftcards-list" style="<?php echo empty($appliedGiftcards) ? 'display:none;' : '' ?> margin-bottom: 15px;">
        <?php foreach ($appliedGiftcards as $code => $data): ?>
        <div class="applied-giftcard-item" data-code="<?php echo $this->escapeHtml($code) ?>" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #fff; border: 1px solid #ddd; border-radius: 3px; margin-bottom: 8px;">
            <div class="giftcard-info">
                <span class="giftcard-code" style="font-weight: 500; font-family: monospace;"><?php echo $this->escapeHtml($data['display_code']) ?></span>
                <span class="giftcard-amount" style="color: #2e7d32; margin-left: 10px;">-<?php echo $this->formatPrice($data['amount']) ?></span>
            </div>
            <button type="button" class="btn-remove-giftcard" data-code="<?php echo $this->escapeHtml($code) ?>" style="background: none; border: none; color: #c62828; cursor: pointer; font-size: 12px; padding: 5px;">
                <?php echo $this->__('Remove') ?>
            </button>
        </div>
        <?php endforeach; ?>
    </div>

    <!-- Gift Card Input Form -->
    <div id="giftcard-apply-form" style="<?php echo $isFullyCovered ? 'display:none;' : '' ?>">
        <div style="display: flex; gap: 10px;">
            <input type="text"
                   id="checkout-giftcard-code"
                   name="giftcard_code"
                   placeholder="<?php echo $this->quoteEscape($this->__('Enter gift card code')) ?>"
                   style="flex: 1; padding: 8px 12px; border: 1px solid #ccc; border-radius: 3px; font-size: 14px;"
                   autocomplete="off">
            <button type="button"
                    id="btn-apply-giftcard"
                    class="button"
                    style="padding: 8px 16px; white-space: nowrap;">
                <?php echo $this->__('Apply') ?>
            </button>
        </div>
        <div id="giftcard-message" style="display: none; margin-top: 8px; padding: 8px; border-radius: 3px; font-size: 13px;"></div>
    </div>

    <!-- Amount Summary -->
    <div id="giftcard-summary" style="<?php echo $totalGiftcardAmount <= 0 ? 'display:none;' : '' ?> margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
        <?php if ($totalGiftcardAmount > 0): ?>
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;">
            <span><?php echo $this->__('Order Total:') ?></span>
            <span id="subtotal-before-giftcard"><?php echo $this->formatPrice($subtotalBeforeGiftcard) ?></span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; color: #2e7d32;">
            <span><?php echo $this->__('Gift Card(s):') ?></span>
            <span id="total-giftcard-amount">-<?php echo $this->formatPrice($totalGiftcardAmount) ?></span>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: 600; padding-top: 5px; border-top: 1px dashed #ccc;">
            <span><?php echo $this->__('Amount Due:') ?></span>
            <span id="amount-due"><?php echo $this->formatPrice($amountDue) ?></span>
        </div>
        <?php endif; ?>
    </div>

    <!-- Fully Covered Message -->
    <div id="fully-covered-message" style="<?php echo !$isFullyCovered ? 'display:none;' : '' ?> margin-top: 15px; padding: 12px; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 3px; color: #2e7d32; text-align: center;">
        <strong><?php echo $this->__('Your order is fully covered by gift cards!') ?></strong>
        <p style="margin: 5px 0 0; font-size: 12px;"><?php echo $this->__('No additional payment is required.') ?></p>
    </div>
</div>

<script type="module">
const GiftcardCheckout = {
    config: {
        applyUrl: <?php echo Mage::helper('core')->jsonEncode($this->getApplyUrl()) ?>,
        removeUrl: <?php echo Mage::helper('core')->jsonEncode($this->getRemoveUrl()) ?>,
        formKey: <?php echo Mage::helper('core')->jsonEncode(Mage::getSingleton('core/session')->getFormKey()) ?>
    },

    init() {
        this.bindEvents();
    },

    bindEvents() {
        const applyBtn = document.getElementById('btn-apply-giftcard');
        const codeInput = document.getElementById('checkout-giftcard-code');

        if (applyBtn) {
            applyBtn.addEventListener('click', () => this.applyGiftcard());
        }

        if (codeInput) {
            codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.applyGiftcard();
                }
            });
            codeInput.addEventListener('input', () => this.clearMessage());
        }

        // Bind remove buttons
        this.bindRemoveButtons();
    },

    bindRemoveButtons() {
        document.querySelectorAll('.btn-remove-giftcard').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const code = e.target.dataset.code;
                if (code) {
                    this.removeGiftcard(code);
                }
            });
        });
    },

    async applyGiftcard() {
        const codeInput = document.getElementById('checkout-giftcard-code');
        const code = codeInput?.value.trim();

        if (!code) {
            this.showMessage(<?php echo Mage::helper('core')->jsonEncode($this->__('Please enter a gift card code.')) ?>, 'error');
            return;
        }

        const applyBtn = document.getElementById('btn-apply-giftcard');
        applyBtn.disabled = true;
        applyBtn.textContent = <?php echo Mage::helper('core')->jsonEncode($this->__('Applying...')) ?>;

        try {
            const response = await mahoFetch(this.config.applyUrl, {
                method: 'POST',
                body: new URLSearchParams({
                    form_key: this.config.formKey,
                    giftcard_code: code
                })
            });

            if (response.success) {
                this.showMessage(response.message, 'success');
                codeInput.value = '';
                this.updateUI(response.data);
                this.updatePaymentMethods(response.data.is_fully_covered);
            } else {
                this.showMessage(response.message, 'error');
            }
        } catch (error) {
            this.showMessage(<?php echo Mage::helper('core')->jsonEncode($this->__('An error occurred. Please try again.')) ?>, 'error');
        } finally {
            applyBtn.disabled = false;
            applyBtn.textContent = <?php echo Mage::helper('core')->jsonEncode($this->__('Apply')) ?>;
        }
    },

    async removeGiftcard(code) {
        try {
            const response = await mahoFetch(this.config.removeUrl, {
                method: 'POST',
                body: new URLSearchParams({
                    form_key: this.config.formKey,
                    code: code
                })
            });

            if (response.success) {
                this.updateUI(response.data);
                this.updatePaymentMethods(response.data.is_fully_covered);
            } else {
                this.showMessage(response.message, 'error');
            }
        } catch (error) {
            this.showMessage(<?php echo Mage::helper('core')->jsonEncode($this->__('An error occurred. Please try again.')) ?>, 'error');
        }
    },

    updateUI(data) {
        const listContainer = document.getElementById('applied-giftcards-list');
        const summaryContainer = document.getElementById('giftcard-summary');
        const applyForm = document.getElementById('giftcard-apply-form');
        const fullyCoveredMsg = document.getElementById('fully-covered-message');

        // Update applied giftcards list
        if (data.giftcards.length > 0) {
            listContainer.innerHTML = data.giftcards.map(gc => `
                <div class="applied-giftcard-item" data-code="${gc.code}" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #fff; border: 1px solid #ddd; border-radius: 3px; margin-bottom: 8px;">
                    <div class="giftcard-info">
                        <span class="giftcard-code" style="font-weight: 500; font-family: monospace;">${gc.display_code}</span>
                        <span class="giftcard-amount" style="color: #2e7d32; margin-left: 10px;">-${gc.amount_formatted}</span>
                    </div>
                    <button type="button" class="btn-remove-giftcard" data-code="${gc.code}" style="background: none; border: none; color: #c62828; cursor: pointer; font-size: 12px; padding: 5px;">
                        ${<?php echo Mage::helper('core')->jsonEncode($this->__('Remove')) ?>}
                    </button>
                </div>
            `).join('');
            listContainer.style.display = '';
            this.bindRemoveButtons();
        } else {
            listContainer.innerHTML = '';
            listContainer.style.display = 'none';
        }

        // Update summary
        if (data.total_giftcard_amount > 0) {
            summaryContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;">
                    <span>${<?php echo Mage::helper('core')->jsonEncode($this->__('Order Total:')) ?>}</span>
                    <span id="subtotal-before-giftcard">${data.subtotal_before_giftcard_formatted}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; color: #2e7d32;">
                    <span>${<?php echo Mage::helper('core')->jsonEncode($this->__('Gift Card(s):')) ?>}</span>
                    <span id="total-giftcard-amount">-${data.total_giftcard_amount_formatted}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: 600; padding-top: 5px; border-top: 1px dashed #ccc;">
                    <span>${<?php echo Mage::helper('core')->jsonEncode($this->__('Amount Due:')) ?>}</span>
                    <span id="amount-due">${data.amount_due_formatted}</span>
                </div>
            `;
            summaryContainer.style.display = '';
        } else {
            summaryContainer.style.display = 'none';
        }

        // Show/hide fully covered message and apply form
        if (data.is_fully_covered) {
            fullyCoveredMsg.style.display = '';
            applyForm.style.display = 'none';
        } else {
            fullyCoveredMsg.style.display = 'none';
            applyForm.style.display = '';
        }

        // Update the checkout totals if available
        if (typeof checkout !== 'undefined' && checkout.reloadTotals) {
            checkout.reloadTotals();
        }
    },

    updatePaymentMethods(isFullyCovered) {
        const paymentMethodsContainer = document.getElementById('checkout-payment-method-load');
        if (!paymentMethodsContainer) return;

        const paymentMethods = paymentMethodsContainer.querySelectorAll('dt');
        const giftcardMethod = document.getElementById('dt_method_giftcard');
        const freeMethod = document.getElementById('dt_method_free');

        if (isFullyCovered) {
            // Hide all payment methods except giftcard/free
            paymentMethods.forEach(method => {
                const methodId = method.id;
                if (methodId === 'dt_method_giftcard' || methodId === 'dt_method_free') {
                    method.style.display = '';
                    const dd = method.nextElementSibling;
                    if (dd && dd.tagName === 'DD') {
                        dd.style.display = '';
                    }
                    // Auto-select
                    const radio = method.querySelector('input[type="radio"]');
                    if (radio && !document.querySelector('#checkout-payment-method-load input[type="radio"]:checked')) {
                        radio.checked = true;
                        if (typeof payment !== 'undefined' && payment.switchMethod) {
                            payment.switchMethod(radio.value);
                        }
                    }
                } else {
                    method.style.display = 'none';
                    const dd = method.nextElementSibling;
                    if (dd && dd.tagName === 'DD') {
                        dd.style.display = 'none';
                    }
                }
            });
        } else {
            // Show all payment methods except giftcard (which is only for full coverage)
            paymentMethods.forEach(method => {
                const methodId = method.id;
                if (methodId === 'dt_method_giftcard') {
                    method.style.display = 'none';
                    const dd = method.nextElementSibling;
                    if (dd && dd.tagName === 'DD') {
                        dd.style.display = 'none';
                    }
                } else {
                    method.style.display = '';
                    const dd = method.nextElementSibling;
                    if (dd && dd.tagName === 'DD') {
                        dd.style.display = '';
                    }
                }
            });
        }
    },

    showMessage(message, type) {
        const messageContainer = document.getElementById('giftcard-message');
        if (!messageContainer) return;

        messageContainer.textContent = message;
        messageContainer.style.display = 'block';

        if (type === 'error') {
            messageContainer.style.background = '#ffebee';
            messageContainer.style.color = '#c62828';
            messageContainer.style.border = '1px solid #ef9a9a';
        } else {
            messageContainer.style.background = '#e8f5e9';
            messageContainer.style.color = '#2e7d32';
            messageContainer.style.border = '1px solid #c8e6c9';
        }

        // Auto-hide success messages
        if (type === 'success') {
            setTimeout(() => this.clearMessage(), 3000);
        }
    },

    clearMessage() {
        const messageContainer = document.getElementById('giftcard-message');
        if (messageContainer) {
            messageContainer.style.display = 'none';
            messageContainer.textContent = '';
        }
    }
};

// Initialize when DOM is ready
GiftcardCheckout.init();

// Also initialize payment methods visibility on load
document.addEventListener('DOMContentLoaded', () => {
    const isFullyCovered = <?php echo $isFullyCovered ? 'true' : 'false' ?>;
    GiftcardCheckout.updatePaymentMethods(isFullyCovered);
});
</script>
<?php endif; ?>
