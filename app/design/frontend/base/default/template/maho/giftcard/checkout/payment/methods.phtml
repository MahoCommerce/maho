<?php
/**
 * Maho
 *
 * Gift card payment methods visibility handler
 * This script runs on page load and handles initial visibility of payment methods
 * based on whether gift cards fully cover the order. AJAX updates are handled
 * by the gift card checkout JavaScript module.
 *
 * @category   design
 * @package    base_default
 * @copyright  Copyright (c) 2025-2026 Maho (https://mahocommerce.com)
 * @license    https://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */

/** @var Mage_Core_Block_Template $this */
$quote = Mage::getSingleton('checkout/session')->getQuote();
$grandTotal = (float) $quote->getGrandTotal();
$giftcardAmount = abs((float) $quote->getGiftcardAmount());

// Check if gift cards cover the full order
$isFullyCovered = ($giftcardAmount > 0 && $grandTotal <= 0.01);
?>

<script type="text/javascript">
//<![CDATA[
(function() {
    const isFullyCovered = <?php echo $isFullyCovered ? 'true' : 'false' ?>;

    function updatePaymentMethodsVisibility() {
        const container = document.getElementById('checkout-payment-method-load');
        if (!container) return;

        const paymentMethods = container.querySelectorAll('dt');

        if (isFullyCovered) {
            // Hide all payment methods except giftcard/free
            let methodSelected = false;

            paymentMethods.forEach(function(method) {
                const methodId = method.id;
                const dd = method.nextElementSibling;

                if (methodId === 'dt_method_giftcard' || methodId === 'dt_method_free') {
                    method.style.display = '';
                    if (dd && dd.tagName === 'DD') {
                        dd.style.display = '';
                    }

                    // Auto-select the first available zero-total method
                    if (!methodSelected) {
                        const radio = method.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = true;
                            if (typeof payment !== 'undefined' && payment.switchMethod) {
                                const methodCode = methodId.replace('dt_method_', '');
                                payment.switchMethod(methodCode);
                            }
                            methodSelected = true;
                        }
                    }
                } else {
                    method.style.display = 'none';
                    if (dd && dd.tagName === 'DD') {
                        dd.style.display = 'none';
                    }
                }
            });
        } else {
            // Show all payment methods except giftcard (which is only for full coverage)
            paymentMethods.forEach(function(method) {
                const methodId = method.id;
                const dd = method.nextElementSibling;

                if (methodId === 'dt_method_giftcard') {
                    method.style.display = 'none';
                    if (dd && dd.tagName === 'DD') {
                        dd.style.display = 'none';
                    }
                } else {
                    method.style.display = '';
                    if (dd && dd.tagName === 'DD') {
                        dd.style.display = '';
                    }
                }
            });
        }
    }

    // Run when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updatePaymentMethodsVisibility);
    } else {
        updatePaymentMethodsVisibility();
    }
})();
//]]>
</script>