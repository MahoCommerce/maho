<?php
/**
 * Maho
 *
 * @category   design
 * @package    base_default
 * @copyright  Copyright (c) 2025-2026 Maho (https://mahocommerce.com)
 * @license    https://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */

/** @var Maho_Giftcard_Block_Catalog_Product_View_Type_Giftcard $this */
$product = $this->getProduct();
$type = $this->getGiftcardType();
$amounts = $this->getGiftcardAmounts();
$isMessageAllowed = $this->isMessageAllowed();
?>

<?php if ($product->isSaleable()): ?>
<style>
.giftcard-options {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.giftcard-options .fields-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}
@media (max-width: 600px) {
    .giftcard-options .fields-row {
        grid-template-columns: 1fr;
    }
}
.giftcard-options .field {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}
.giftcard-options .field.full-width {
    grid-column: 1 / -1;
}
.giftcard-options input[type="text"],
.giftcard-options input[type="email"],
.giftcard-options textarea {
    width: 100%;
}
.giftcard-options textarea {
    max-width: none;
}
</style>

<div class="giftcard-options">
    <!-- Amount -->
    <?php if ($type === 'fixed' && !empty($amounts)): ?>
        <div class="field">
            <label for="giftcard_amount" class="required">
                <?php echo $this->__('Select Amount'); ?>
            </label>
            <select name="giftcard_amount" id="giftcard_amount" class="required-entry" required>
                <option value=""><?php echo $this->__('-- Please Select --'); ?></option>
                <?php foreach ($amounts as $amount): ?>
                    <option value="<?php echo $this->escapeHtml($amount); ?>">
                        <?php echo $this->formatPrice((float)$amount); ?>
                    </option>
                <?php endforeach; ?>
            </select>
        </div>
    <?php else: ?>
        <div class="field">
            <label for="giftcard_amount" class="required">
                <?php echo $this->__('Amount'); ?>
                <?php if ($this->getMinAmount() || $this->getMaxAmount()): ?>
                    <span class="hint">
                        (<?php if ($this->getMinAmount()): ?><?php echo $this->formatPrice($this->getMinAmount()); ?><?php endif; ?>
                        <?php if ($this->getMinAmount() && $this->getMaxAmount()): ?> - <?php endif; ?>
                        <?php if ($this->getMaxAmount()): ?><?php echo $this->formatPrice($this->getMaxAmount()); ?><?php endif; ?>)
                    </span>
                <?php endif; ?>
            </label>
            <input
                type="text"
                name="giftcard_amount"
                id="giftcard_amount"
                class="required-entry validate-number validate-greater-than-zero"
                required
                <?php if ($this->getMinAmount()): ?>data-validate-min="<?php echo $this->getMinAmount(); ?>"<?php endif; ?>
                <?php if ($this->getMaxAmount()): ?>data-validate-max="<?php echo $this->getMaxAmount(); ?>"<?php endif; ?>
            />
        </div>
    <?php endif; ?>

    <!-- Sender -->
    <div class="fields-row">
        <div class="field">
            <label for="giftcard_sender_name" class="required"><?php echo $this->__('Your Name'); ?></label>
            <input type="text" name="giftcard_sender_name" id="giftcard_sender_name" class="required-entry" maxlength="255" required />
        </div>
        <div class="field">
            <label for="giftcard_sender_email" class="required"><?php echo $this->__('Your Email'); ?></label>
            <input type="email" name="giftcard_sender_email" id="giftcard_sender_email" class="required-entry validate-email" maxlength="255" required />
        </div>
    </div>

    <!-- Recipient -->
    <div class="fields-row">
        <div class="field">
            <label for="giftcard_recipient_name" class="required"><?php echo $this->__('Recipient Name'); ?></label>
            <input type="text" name="giftcard_recipient_name" id="giftcard_recipient_name" class="required-entry" maxlength="255" required />
        </div>
        <div class="field">
            <label for="giftcard_recipient_email" class="required"><?php echo $this->__('Recipient Email'); ?></label>
            <input type="email" name="giftcard_recipient_email" id="giftcard_recipient_email" class="required-entry validate-email" maxlength="255" required />
        </div>
    </div>

    <!-- Optional -->
    <?php if ($isMessageAllowed): ?>
    <div class="fields-row">
        <div class="field full-width">
            <label for="giftcard_message"><?php echo $this->__('Personal Message'); ?></label>
            <textarea name="giftcard_message" id="giftcard_message" maxlength="500" placeholder="<?php echo $this->__('Add a message...'); ?>"></textarea>
        </div>
        <div class="field">
            <label for="giftcard_delivery_date"><?php echo $this->__('Schedule Delivery'); ?></label>
            <input type="date" name="giftcard_delivery_date" id="giftcard_delivery_date" min="<?php echo date('Y-m-d'); ?>" />
            <p class="note"><?php echo $this->__('Leave blank for immediate delivery'); ?></p>
        </div>
    </div>
    <?php else: ?>
    <div class="field">
        <label for="giftcard_delivery_date"><?php echo $this->__('Schedule Delivery'); ?> <span class="hint">(<?php echo $this->__('Optional'); ?>)</span></label>
        <input type="date" name="giftcard_delivery_date" id="giftcard_delivery_date" min="<?php echo date('Y-m-d'); ?>" />
        <p class="note"><?php echo $this->__('Leave blank for immediate delivery'); ?></p>
    </div>
    <?php endif; ?>
</div>

<script type="module">
const amountField = document.getElementById('giftcard_amount');
const currencySymbol = '<?php echo Mage::app()->getStore()->getCurrentCurrency()->getCurrencySymbol(); ?>';

function updateGiftCardPrice(amount) {
    const price = parseFloat(amount);
    if (!isNaN(price) && price > 0) {
        document.querySelectorAll('.price-box .price').forEach(el => {
            el.innerHTML = currencySymbol + price.toFixed(2);
        });
        if (typeof optionsPrice !== 'undefined' && optionsPrice) {
            optionsPrice.productPrice = price;
            optionsPrice.reload();
        }
    }
}

if (amountField) {
    if (amountField.tagName === 'SELECT') {
        amountField.addEventListener('change', () => updateGiftCardPrice(amountField.value));
        if (amountField.value) updateGiftCardPrice(amountField.value);
    } else {
        <?php if ($this->getMinAmount()): ?>
        const minAmount = <?php echo $this->getMinAmount(); ?>;
        <?php endif; ?>
        <?php if ($this->getMaxAmount()): ?>
        const maxAmount = <?php echo $this->getMaxAmount(); ?>;
        <?php endif; ?>

        amountField.addEventListener('input', () => updateGiftCardPrice(amountField.value));
        amountField.addEventListener('blur', () => {
            let value = parseFloat(amountField.value);
            if (isNaN(value) || value <= 0) {
                amountField.value = '';
                return;
            }
            <?php if ($this->getMinAmount()): ?>
            if (value < minAmount) {
                amountField.value = minAmount.toFixed(2);
                value = minAmount;
            }
            <?php endif; ?>
            <?php if ($this->getMaxAmount()): ?>
            if (value > maxAmount) {
                amountField.value = maxAmount.toFixed(2);
                value = maxAmount;
            }
            <?php endif; ?>
            amountField.value = value.toFixed(2);
            updateGiftCardPrice(value);
        });

        <?php if ($this->getMinAmount()): ?>
        if (!amountField.value) {
            amountField.value = minAmount.toFixed(2);
            updateGiftCardPrice(minAmount);
        }
        <?php endif; ?>
    }
}
</script>
<?php endif; ?>
