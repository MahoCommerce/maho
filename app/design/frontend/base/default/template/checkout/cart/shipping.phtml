<?php
/**
 * Maho
 *
 * @package     base_default
 * @copyright   Copyright (c) 2006-2020 Magento, Inc. (https://magento.com)
 * @copyright   Copyright (c) 2021-2024 The OpenMage Contributors (https://openmage.org)
 * @copyright   Copyright (c) 2024-2026 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php /** @var Mage_Checkout_Block_Cart_Shipping $this */ ?>
<div class="shipping" id="shipping-container">
    <h2><?= $this->__('Estimate Shipping and Tax') ?></h2>
    <div class="shipping-form">
       <form action="<?= $this->getFormActionUrl() ?>" method="post" id="shipping-zip-form">
            <div class="shipping-fields-grid">
                <div class="form-field">
                    <label for="country" class="required"><em>*</em> <?= $this->__('Country') ?></label>
                    <?= Mage::getBlockSingleton('directory/data')->getCountryHtmlSelect($this->getEstimateCountryId()) ?>
                </div>
                <div class="form-field">
                    <label for="region_id" class="required"><em>*</em> <?= $this->__('State/Province') ?></label>
                    <select id="region_id" name="region_id" title="<?= $this->quoteEscape($this->__('State/Province')) ?>" style="display:none;"<?= ($this->isStateProvinceRequired() ? ' class="validate-select"' : '') ?>>
                        <option value=""><?= $this->__('Please select region, state or province') ?></option>
                    </select>
                    <script type="text/javascript">
                        document.getElementById('region_id').setAttribute('defaultValue', "<?= $this->getEstimateRegionId() ?>");
                    </script>
                    <input type="text" id="region" name="region" value="<?= $this->escapeHtml($this->getEstimateRegion()) ?>" title="<?= $this->quoteEscape($this->__('State/Province')) ?>" class="input-text" style="display:none;" />
                </div>
            </div>
            <?php if ($this->getCityActive()): ?>
            <div class="shipping-city-field">
                <label for="city"<?= $this->isCityRequired() ? ' class="required"' : '' ?>><?php if ($this->isCityRequired()): ?><em>*</em> <?php endif ?><?= $this->__('City') ?></label>
                <input class="input-text<?php if ($this->isCityRequired()):?> required-entry<?php endif ?>" id="city" type="text" name="estimate_city" value="<?= $this->escapeHtml($this->getEstimateCity()) ?>" />
            </div>
            <?php endif ?>
            <div class="shipping-zip-row">
                <div class="zip-field">
                    <label for="postcode" class="required"><em>*</em> <?= $this->__('Zip') ?></label>
                    <input class="input-text validate-postcode<?php if ($this->isZipCodeRequired()):?> required-entry<?php endif ?>" type="text" id="postcode" name="estimate_postcode" value="<?= $this->escapeHtml($this->getEstimatePostcode()) ?>" />
                </div>
                <button type="submit" title="<?= $this->quoteEscape($this->__('Estimate')) ?>" class="button2 btn-estimate">
                    <?= $this->__('Estimate') ?>
                </button>
            </div>
        </form>
        <script type="text/javascript">
            new RegionUpdater('country', 'region', 'region_id', <?= Mage::helper('directory')->getRegionJsonByStore() ?>);
        </script>

        <div id="co-shipping-method-form-container">
            <?= $this->setTemplate('checkout/cart/shipping/rates.phtml')->toHtml() ?>
        </div>

        <script type="text/javascript">
        (function() {
            const countriesWithOptionalZip = <?= $this->helper('directory')->getCountriesWithOptionalZip(true) ?>;
            const form = document.getElementById('shipping-zip-form');
            const container = document.getElementById('co-shipping-method-form-container');
            const shippingContainer = document.getElementById('shipping-container');

            function validate() {
                const country = document.getElementById('country').value;
                const postcodeEl = document.getElementById('postcode');
                postcodeEl.classList.toggle('required-entry', !countriesWithOptionalZip.includes(country));

                let valid = true;
                form.querySelectorAll('.required-entry').forEach(field => {
                    if (field.offsetParent === null || field.style.display === 'none') return;
                    field.classList.toggle('validation-failed', !field.value.trim());
                    if (!field.value.trim()) valid = false;
                });
                return valid;
            }

            function updateTotals(html) {
                if (!html) return;
                const totalsTable = document.getElementById('shopping-cart-totals-table');
                if (!totalsTable) return;
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const newTable = temp.querySelector('#shopping-cart-totals-table');
                if (newTable) totalsTable.innerHTML = newTable.innerHTML;
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validate()) return;

                try {
                    const result = await mahoFetch(form.action, {
                        method: 'POST',
                        body: new URLSearchParams(new FormData(form)),
                        loaderArea: shippingContainer
                    });
                    if (result.rates_html) container.innerHTML = result.rates_html;
                } catch (error) {
                    alert(error.message);
                }
            });

            container.addEventListener('submit', async (e) => {
                if (e.target.id !== 'co-shipping-method-form') return;
                e.preventDefault();

                try {
                    const result = await mahoFetch(e.target.action, {
                        method: 'POST',
                        body: new URLSearchParams(new FormData(e.target)),
                        loaderArea: shippingContainer
                    });
                    updateTotals(result.totals_html);
                } catch (error) {
                    alert(error.message);
                }
            });
        })();
        </script>
    </div>
</div>
