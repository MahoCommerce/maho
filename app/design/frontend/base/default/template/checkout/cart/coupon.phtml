<?php
/**
 * Maho
 *
 * @package     base_default
 * @copyright   Copyright (c) 2006-2020 Magento, Inc. (https://magento.com)
 * @copyright   Copyright (c) 2021-2023 The OpenMage Contributors (https://openmage.org)
 * @copyright   Copyright (c) 2024-2026 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/** @var Mage_Checkout_Block_Cart_Coupon $this */

// Get currently applied promo codes
$couponCode = $this->getCouponCode();
$giftcardCodes = [];
$giftcardEnabled = Mage::helper('core')->isModuleEnabled('Maho_Giftcard');

if ($giftcardEnabled) {
    $quote = Mage::getSingleton('checkout/session')->getQuote();
    $giftcardCodesJson = $quote->getGiftcardCodes();
    if ($giftcardCodesJson) {
        $giftcardCodes = json_decode($giftcardCodesJson, true) ?: [];
    }
}

$hasAppliedCodes = !empty($couponCode) || !empty($giftcardCodes);
?>
<div class="promo-code-section" id="promo-code-section">
    <?php if ($hasAppliedCodes): ?>
    <div class="applied-codes" id="applied-promo-codes">
        <?php if ($couponCode): ?>
        <div class="applied-code applied-coupon" data-type="coupon" data-code="<?= $this->escapeHtml($couponCode) ?>">
            <span class="code-label"><?= $this->__('Coupon:') ?></span>
            <span class="code-value"><?= $this->escapeHtml($couponCode) ?></span>
            <button type="button" class="btn-remove-code" title="<?= $this->quoteEscape($this->__('Remove')) ?>">×</button>
        </div>
        <?php endif ?>
        <?php foreach ($giftcardCodes as $code => $amount): ?>
        <?php
            $displayCode = strlen($code) > 8
                ? substr($code, 0, 4) . str_repeat('*', strlen($code) - 8) . substr($code, -4)
                : $code;
            $formattedAmount = Mage::helper('core')->currency($amount, true, false);
        ?>
        <div class="applied-code applied-giftcard" data-type="giftcard" data-code="<?= $this->escapeHtml($code) ?>">
            <span class="code-label"><?= $this->__('Gift Card:') ?></span>
            <span class="code-value"><?= $this->escapeHtml($displayCode) ?></span>
            <span class="code-amount">-<?= $formattedAmount ?></span>
            <button type="button" class="btn-remove-code" title="<?= $this->quoteEscape($this->__('Remove')) ?>">×</button>
        </div>
        <?php endforeach ?>
    </div>
    <?php endif ?>

    <div class="promo-code-form">
        <div class="coupon-input-group">
            <label for="promo_code" class="visually-hidden"><?= $this->__('Enter promo code') ?></label>
            <input
                class="input-text coupon-input"
                type="text"
                id="promo_code"
                name="promo_code"
                value=""
                placeholder="<?= $giftcardEnabled ? $this->__('Discount code or gift card') : $this->__('Enter discount code') ?>" />
            <button type="button" id="btn-apply-promo" title="<?= $this->quoteEscape($this->__('Apply')) ?>" class="button2 btn-apply"><?= $this->__('Apply') ?></button>
        </div>
        <div id="promo-code-message" class="promo-message"></div>
    </div>
</div>

<script type="module">
const PromoCode = {
    config: {
        applyUrl: '<?= $this->getUrl('checkout/cart/couponPost') ?>',
        formKey: '<?= Mage::getSingleton('core/session')->getFormKey() ?>'
    },

    init() {
        this.bindEvents();
    },

    bindEvents() {
        const applyBtn = document.getElementById('btn-apply-promo');
        const codeInput = document.getElementById('promo_code');

        if (applyBtn) {
            applyBtn.addEventListener('click', () => this.applyCode());
        }

        if (codeInput) {
            codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.applyCode();
                }
            });
            codeInput.addEventListener('input', () => this.clearMessage());
        }

        // Bind remove buttons
        this.bindRemoveButtons();
    },

    bindRemoveButtons() {
        document.querySelectorAll('.btn-remove-code').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const codeEl = e.target.closest('.applied-code');
                if (codeEl) {
                    const type = codeEl.dataset.type;
                    const code = codeEl.dataset.code;
                    this.removeCode(type, code);
                }
            });
        });
    },

    async applyCode() {
        const codeInput = document.getElementById('promo_code');
        const code = codeInput?.value.trim();

        if (!code) {
            this.showMessage(<?= Mage::helper('core')->jsonEncode($this->__('Please enter a promo code.')) ?>, 'error');
            return;
        }

        const applyBtn = document.getElementById('btn-apply-promo');
        const originalText = applyBtn.textContent;
        applyBtn.disabled = true;
        applyBtn.textContent = <?= Mage::helper('core')->jsonEncode($this->__('Applying...')) ?>;

        try {
            const response = await mahoFetch(this.config.applyUrl, {
                method: 'POST',
                body: new URLSearchParams({
                    form_key: this.config.formKey,
                    promo_code: code,
                    isAjax: '1'
                })
            });

            if (response.success) {
                this.showMessage(response.message, 'success');
                codeInput.value = '';
                // Reload page to update totals and applied codes display
                setTimeout(() => window.location.reload(), 500);
            } else {
                this.showMessage(response.message, 'error');
            }
        } catch (error) {
            this.showMessage(<?= Mage::helper('core')->jsonEncode($this->__('An error occurred. Please try again.')) ?>, 'error');
        } finally {
            applyBtn.disabled = false;
            applyBtn.textContent = originalText;
        }
    },

    async removeCode(type, code) {
        try {
            const response = await mahoFetch(this.config.applyUrl, {
                method: 'POST',
                body: new URLSearchParams({
                    form_key: this.config.formKey,
                    remove_type: type,
                    remove_code: code,
                    isAjax: '1'
                })
            });

            if (response.success) {
                // Reload page to update totals
                window.location.reload();
            } else {
                this.showMessage(response.message, 'error');
            }
        } catch (error) {
            this.showMessage(<?= Mage::helper('core')->jsonEncode($this->__('An error occurred. Please try again.')) ?>, 'error');
        }
    },

    showMessage(message, type) {
        const messageContainer = document.getElementById('promo-code-message');
        if (!messageContainer) return;

        messageContainer.textContent = message;
        messageContainer.className = 'promo-message ' + type;

        if (type === 'success') {
            setTimeout(() => this.clearMessage(), 3000);
        }
    },

    clearMessage() {
        const messageContainer = document.getElementById('promo-code-message');
        if (messageContainer) {
            messageContainer.textContent = '';
            messageContainer.className = 'promo-message';
        }
    }
};

PromoCode.init();
</script>
