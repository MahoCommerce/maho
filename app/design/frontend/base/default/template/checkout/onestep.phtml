<?php
/**
 * Maho
 *
 * @package    base_default
 * @copyright  Copyright (c) 2026 Maho (https://mahocommerce.com)
 * @license    https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/** @var Mage_Checkout_Block_Onepage $this */
$isVirtual = $this->getQuote()->isVirtual();
$isLoggedIn = $this->isCustomerLoggedIn();

// Get applied promo codes
$couponCode = $this->getQuote()->getCouponCode();
$giftcardCodes = [];
$giftcardEnabled = Mage::helper('core')->isModuleEnabled('Maho_Giftcard');

if ($giftcardEnabled) {
    $giftcardCodesJson = $this->getQuote()->getGiftcardCodes();
    if ($giftcardCodesJson) {
        $giftcardCodes = json_decode($giftcardCodesJson, true) ?: [];
    }
}

$hasAppliedCodes = !empty($couponCode) || !empty($giftcardCodes);
?>
<div class="onestep-header">
    <div class="page-title">
        <h1><?= $this->__('Checkout') ?></h1>
    </div>
    <?php if (!$isLoggedIn): ?>
    <div class="onestep-login-bar">
        <span class="onestep-login-text"><?= $this->__('Have an account?') ?></span>
        <a href="<?= $this->getUrl('customer/account/login', ['_secure' => true, 'referer' => base64_encode($this->getUrl('checkout/onepage'))]) ?>" class="button"><?= $this->__('Login') ?></a>
        <a href="<?= $this->getUrl('customer/account/create', ['_secure' => true]) ?>" class="button button-secondary"><?= $this->__('Register') ?></a>
    </div>
    <?php endif ?>
</div>

<div class="onestep-checkout" id="onestep-checkout">
    <!-- Column 1: Address -->
    <div class="onestep-column onestep-column-address">
        <div class="onestep-section" id="onestep-billing">
            <div class="onestep-section-header">
                <h2><?= $this->__('Billing Address') ?></h2>
            </div>
            <div class="onestep-section-content" id="checkout-step-billing">
                <?= $this->getChildHtml('billing') ?>
            </div>
        </div>

        <?php if (!$isVirtual): ?>
        <div class="onestep-section" id="onestep-shipping" style="display:none;">
            <div class="onestep-section-header">
                <h2><?= $this->__('Shipping Address') ?></h2>
            </div>
            <div class="onestep-section-content" id="checkout-step-shipping">
                <?= $this->getChildHtml('shipping') ?>
            </div>
        </div>
        <?php endif ?>
    </div>

    <!-- Column 2: Promo Code, Shipping & Payment Methods + Order Summary -->
    <div class="onestep-column onestep-column-right">
        <div class="onestep-section" id="onestep-promo">
            <div class="onestep-section-header">
                <h2><?= $this->__('Discounts') ?></h2>
            </div>
            <div class="onestep-section-content">
                <div class="promo-code-form">
                    <div class="coupon-input-group">
                        <label for="onestep-promo-code" class="visually-hidden"><?= $this->__('Enter promo code') ?></label>
                        <input type="text"
                               id="onestep-promo-code"
                               class="input-text coupon-input"
                               value=""
                               placeholder="<?= $giftcardEnabled ? $this->__('Discount code or gift card') : $this->__('Enter discount code') ?>" />
                        <button type="button" id="onestep-promo-apply" class="button2 btn-apply"><?= $this->__('Apply') ?></button>
                    </div>
                    <div id="onestep-promo-message" class="promo-message"></div>
                </div>

                <?php if ($hasAppliedCodes): ?>
                <div class="applied-codes" id="onestep-applied-codes">
                    <?php if ($couponCode): ?>
                    <div class="applied-code applied-coupon" data-type="coupon" data-code="<?= $this->escapeHtml($couponCode) ?>">
                        <span class="code-label"><?= $this->__('Coupon:') ?></span>
                        <span class="code-value"><?= $this->escapeHtml($couponCode) ?></span>
                        <button type="button" class="btn-remove-code" title="<?= $this->quoteEscape($this->__('Remove')) ?>">×</button>
                    </div>
                    <?php endif ?>
                    <?php foreach ($giftcardCodes as $code => $amount): ?>
                    <?php
                        $displayCode = strlen($code) > 8
                            ? substr($code, 0, 4) . str_repeat('*', strlen($code) - 8) . substr($code, -4)
                            : $code;
                        $formattedAmount = Mage::helper('core')->currency($amount, true, false);
                    ?>
                    <div class="applied-code applied-giftcard" data-type="giftcard" data-code="<?= $this->escapeHtml($code) ?>">
                        <span class="code-label"><?= $this->__('Gift Card:') ?></span>
                        <span class="code-value"><?= $this->escapeHtml($displayCode) ?></span>
                        <span class="code-amount">-<?= $formattedAmount ?></span>
                        <button type="button" class="btn-remove-code" title="<?= $this->quoteEscape($this->__('Remove')) ?>">×</button>
                    </div>
                    <?php endforeach ?>
                </div>
                <?php endif ?>
            </div>
        </div>

        <div class="onestep-column-methods">
            <?php if (!$isVirtual): ?>
            <div class="onestep-section" id="onestep-shipping-method">
                <div class="onestep-section-header">
                    <h2><?= $this->__('Shipping Method') ?></h2>
                </div>
                <div class="onestep-section-content" id="checkout-step-shipping_method">
                    <div class="onestep-placeholder" id="shipping-method-placeholder">
                        <p><?= $this->__('Waiting for address...') ?></p>
                    </div>
                    <?= $this->getChildHtml('shipping_method') ?>
                </div>
            </div>
            <?php endif ?>

            <div class="onestep-section" id="onestep-payment">
                <div class="onestep-section-header">
                    <h2><?= $this->__('Payment Method') ?></h2>
                </div>
                <div class="onestep-section-content" id="checkout-step-payment">
                    <?= $this->getChildHtml('payment') ?>
                    <div class="onestep-placeholder" id="payment-method-placeholder">
                        <p><?= $this->__('Waiting for shipping method...') ?></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="onestep-column-summary">
            <div class="onestep-section" id="onestep-review">
                <div class="onestep-section-header">
                    <h2><?= $this->__('Summary') ?></h2>
                </div>
                <div class="onestep-section-content" id="checkout-step-review">
                    <div id="checkout-review-load">
                        <!-- Review content will be loaded here -->
                    </div>
                    <div id="onestep-review-please-wait" class="please-wait" style="display:none;">
                        <img src="<?= $this->getSkinUrl('images/loading.svg') ?>" alt="<?= $this->quoteEscape($this->__('Loading...')) ?>" class="v-middle" />
                        <?= $this->__('Loading order summary...') ?>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    // Initialize the one-step checkout
    const onestepCheckout = new OneStepCheckout({
        progress: '<?= $this->getUrl('checkout/onepage/progress') ?>',
        review: '<?= $this->getUrl('checkout/onepage/review') ?>',
        saveBilling: '<?= $this->getUrl('checkout/onepage/saveBilling') ?>',
        saveShipping: '<?= $this->getUrl('checkout/onepage/saveShipping') ?>',
        saveShippingMethod: '<?= $this->getUrl('checkout/onepage/saveShippingMethod') ?>',
        savePayment: '<?= $this->getUrl('checkout/onepage/savePayment') ?>',
        saveOrder: '<?= $this->getUrl('checkout/onepage/saveOrder') ?>',
        successUrl: '<?= $this->getUrl('checkout/onepage/success') ?>',
        failure: '<?= $this->getUrl('checkout/cart') ?>',
        estimateBilling: '<?= $this->getUrl('checkout/onepage/estimateBilling') ?>',
        applyCoupon: '<?= $this->getUrl('checkout/cart/couponPost') ?>',
        formKey: '<?= Mage::getSingleton('core/session')->getFormKey() ?>',
        isVirtual: <?= $isVirtual ? 'true' : 'false' ?>,
        isLoggedIn: <?= $isLoggedIn ? 'true' : 'false' ?>,
        messages: {
            agreementsError: <?= Mage::helper('core')->jsonEncode($this->__('Please agree to all the terms and conditions before placing the order.')) ?>,
            selectMethodsError: <?= Mage::helper('core')->jsonEncode($this->__('Please select shipping and payment methods before placing your order.')) ?>,
            selectShippingMethodError: <?= Mage::helper('core')->jsonEncode($this->__('Please select a shipping method.')) ?>,
            selectPaymentMethodError: <?= Mage::helper('core')->jsonEncode($this->__('Please select a payment method.')) ?>,
            genericError: <?= Mage::helper('core')->jsonEncode($this->__('An error occurred while placing your order. Please try again.')) ?>
        }
    });

    // Initialize promo code handling
    const OnestepPromo = {
        init() {
            this.bindEvents();
        },

        bindEvents() {
            const applyBtn = document.getElementById('onestep-promo-apply');
            const codeInput = document.getElementById('onestep-promo-code');

            if (applyBtn) {
                applyBtn.addEventListener('click', () => this.applyCode());
            }

            if (codeInput) {
                codeInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.applyCode();
                    }
                });
                codeInput.addEventListener('input', () => this.clearMessage());
            }

            this.bindRemoveButtons();
        },

        bindRemoveButtons() {
            document.querySelectorAll('#onestep-promo .btn-remove-code').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const codeEl = e.target.closest('.applied-code');
                    if (codeEl) {
                        this.removeCode(codeEl.dataset.type, codeEl.dataset.code);
                    }
                });
            });
        },

        async applyCode() {
            const codeInput = document.getElementById('onestep-promo-code');
            const code = codeInput?.value.trim();

            if (!code) {
                this.showMessage(<?= Mage::helper('core')->jsonEncode($this->__('Please enter a promo code.')) ?>, 'error');
                return;
            }

            const applyBtn = document.getElementById('onestep-promo-apply');
            const originalText = applyBtn.textContent;
            applyBtn.disabled = true;
            applyBtn.textContent = <?= Mage::helper('core')->jsonEncode($this->__('Applying...')) ?>;

            try {
                const response = await mahoFetch(onestepCheckout.urls.applyCoupon, {
                    method: 'POST',
                    body: new URLSearchParams({
                        form_key: onestepCheckout.formKey,
                        promo_code: code,
                        isAjax: '1'
                    })
                });

                if (response.success) {
                    this.showMessage(response.message, 'success');
                    codeInput.value = '';
                    // Reload the checkout to update totals
                    onestepCheckout.loadReview();
                    setTimeout(() => window.location.reload(), 800);
                } else {
                    this.showMessage(response.message, 'error');
                }
            } catch (error) {
                this.showMessage(<?= Mage::helper('core')->jsonEncode($this->__('An error occurred. Please try again.')) ?>, 'error');
            } finally {
                applyBtn.disabled = false;
                applyBtn.textContent = originalText;
            }
        },

        async removeCode(type, code) {
            try {
                const response = await mahoFetch(onestepCheckout.urls.applyCoupon, {
                    method: 'POST',
                    body: new URLSearchParams({
                        form_key: onestepCheckout.formKey,
                        remove_type: type,
                        remove_code: code,
                        isAjax: '1'
                    })
                });

                if (response.success) {
                    window.location.reload();
                } else {
                    this.showMessage(response.message, 'error');
                }
            } catch (error) {
                this.showMessage(<?= Mage::helper('core')->jsonEncode($this->__('An error occurred. Please try again.')) ?>, 'error');
            }
        },

        showMessage(message, type) {
            const messageContainer = document.getElementById('onestep-promo-message');
            if (!messageContainer) return;

            messageContainer.textContent = message;
            messageContainer.className = 'promo-message ' + type;

            if (type === 'success') {
                setTimeout(() => this.clearMessage(), 3000);
            }
        },

        clearMessage() {
            const messageContainer = document.getElementById('onestep-promo-message');
            if (messageContainer) {
                messageContainer.textContent = '';
                messageContainer.className = 'promo-message';
            }
        }
    };

    OnestepPromo.init();
</script>
