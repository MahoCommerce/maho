<?php
/**
 * Maho
 *
 * @package     base_default
 * @copyright   Copyright (c) 2025-2026 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/** @var Mage_CatalogSearch_Block_Autocomplete $this */

// Category search block
$categoryBlock = $this->getLayout()->createBlock('catalogsearch/autocomplete_category_list');
$categories = $categoryBlock->isEnabled() ? $categoryBlock->getCategoryCollection() : null;
$hasCategories = $categories && count($categories) > 0;

// Product search block
$productList = $this->getLayout()->createBlock('catalogsearch/autocomplete_product_list')
    ->setTemplate('catalog/product/list.phtml');
$numProducts = count($productList->getLoadedProductCollection());

// Collect additional autocomplete content through events
$autocompleteData = new \Maho\DataObject([
    'html' => '',
    'layout' => $this->getLayout()
]);
Mage::dispatchEvent('catalogsearch_autocomplete_collect_content', [
    'autocomplete_data' => $autocompleteData
]);
$additionalAutocompleteHtml = $autocompleteData->getHtml();
?>

<?php if ($numProducts > 0): ?>
    <a class="view-all" onclick="document.getElementById('search_mini_form').submit()" href="#">
        <?= $this->__("View all %s results", $numProducts) ?>
    </a>
<?php endif ?>

<div class="results-list">
    <?php if ($hasCategories): ?>
        <div class="category-results">
            <div class="category-results-title"><?= $this->__('Categories') ?></div>
            <ul class="category-list">
                <?php foreach ($categories as $category): ?>
                    <li class="category-item">
                        <a href="<?= $this->escapeUrl($categoryBlock->getCategoryUrl($category)) ?>" class="category-link">
                            <?php $parentPath = $categoryBlock->getCategoryPath($category); ?>
                            <?php if (!empty($parentPath)): ?>
                                <span class="category-path">
                                    <?php foreach ($parentPath as $pathItem): ?>
                                        <span class="path-item"><?= $this->escapeHtml($pathItem) ?></span>
                                    <?php endforeach ?>
                                </span>
                            <?php endif ?>
                            <span class="category-name"><?= $this->escapeHtml($category->getName()) ?></span>
                        </a>
                    </li>
                <?php endforeach ?>
            </ul>
        </div>
    <?php endif ?>

    <?= $additionalAutocompleteHtml ?>

    <?php if ($numProducts > 0): ?>
        <?php if ($hasCategories || !empty($additionalAutocompleteHtml)): ?>
            <div class="product-results">
                <div class="product-results-title"><?= $this->__('Products') ?></div>
        <?php endif ?>
        <?= $productList->toHtml() ?>
        <?php if ($hasCategories || !empty($additionalAutocompleteHtml)): ?>
            </div>
        <?php endif ?>
    <?php endif ?>
</div>
