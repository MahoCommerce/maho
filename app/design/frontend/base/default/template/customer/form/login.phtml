<?php
/**
 * Maho
 *
 * @package     base_default
 * @copyright   Copyright (c) 2006-2020 Magento, Inc. (https://magento.com)
 * @copyright   Copyright (c) 2021-2023 The OpenMage Contributors (https://openmage.org)
 * @copyright   Copyright (c) 2024-2026 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/** @var Mage_Customer_Block_Form_Login $this */
?>
<?php $isRegistrationAllowed = $this->helper('customer')->isRegistrationAllowed() ?>
<?php $showRegister = (bool)$this->getRequest()->getParam('show_register') ?>
<?php $showForgot = (bool)$this->getRequest()->getParam('show_forgot') ?>
<div class="account-login<?php if (!$isRegistrationAllowed) echo ' login-only' ?>">
    <?= $this->getMessagesBlock()->toHtml() ?>
    <?php /* Extensions placeholder */ ?>
    <?= $this->getChildHtml('customer.form.login.extra') ?>
    <?php $isMagicLinkEnabled = Mage::helper('customer')->isMagicLinkEnabled(); ?>
    <?php $magicLinkMode = $isMagicLinkEnabled ? Mage::helper('customer')->getMagicLinkRegistrationMode() : null; ?>
    <?php $formAction = ($isMagicLinkEnabled && $magicLinkMode === Mage_Customer_Model_Config_Registrationmode::MODE_NO_PASSWORD)
        ? $this->getUrl('customer/account/magicLinkRequestPost')
        : $this->getPostActionUrl(); ?>

    <?php if ($isRegistrationAllowed): ?>
    <!-- Radio inputs for tab selection -->
    <input type="radio" name="account-tab" id="tab-login" class="tab-selector"<?php if (!$showRegister) echo ' checked' ?>>
    <input type="radio" name="account-tab" id="tab-register" class="tab-selector"<?php if ($showRegister) echo ' checked' ?>>

    <!-- Tab labels -->
    <ul class="login-tabs">
        <li><label for="tab-login"><?= $this->__('Login') ?></label></li>
        <li><label for="tab-register"><?= $this->__('Create an account') ?></label></li>
    </ul>
    <?php endif ?>

    <form action="<?= $formAction ?>" method="post" id="login-form" aria-label="<?= $this->__('Login Form') ?>">
        <?= $this->getBlockHtml('formkey') ?>

        <div id="login-tab" class="tab-content">
            <div class="registered-users">
                <fieldset class="content fieldset">
                    <legend class="visually-hidden"><?= $this->__('Login Form') ?></legend>
                    <p class="required"><?= $this->__('* Required Fields') ?></p>
                    <ul class="form-list">
                        <li>
                            <label for="email" class="required" aria-label="<?= $this->__('Required') ?>"><?= $this->__('Email Address') ?></label>
                            <div class="input-box">
                                <input type="email" autocomplete="on" autocapitalize="off" autocorrect="off" spellcheck="false" name="login[username]" value="<?= $this->escapeHtml($this->getUsername()) ?>" id="email" class="input-text required-entry validate-email" title="<?= $this->quoteEscape($this->__('Email Address')) ?>" aria-required="true" />
                            </div>
                        </li>
                        <?php if (!$isMagicLinkEnabled || $magicLinkMode !== Mage_Customer_Model_Config_Registrationmode::MODE_NO_PASSWORD): ?>
                        <li>
                            <?php $minPasswordLength = $this->getMinPasswordLength(); ?>
                            <label for="pass" class="required" aria-label="<?= $this->__('Required') ?>"><?= $this->__('Password') ?></label>
                            <div class="input-box">
                                <input type="password" name="login[password]" class="input-text required-entry validate-password min-pass-length-<?= $minPasswordLength ?>" id="pass" title="<?= $this->quoteEscape($this->__('Password')) ?>" autocomplete="off" aria-required="true" />
                            </div>
                        </li>
                        <?php endif ?>
                        <?= $this->getChildHtml('form.additional.info') ?>
                        <?php if (!$isMagicLinkEnabled || $magicLinkMode !== Mage_Customer_Model_Config_Registrationmode::MODE_NO_PASSWORD): ?>
                        <li>
                            <a href="#" id="show-forgot-password" class="f-left"><?= $this->__('Forgot Your Password?') ?></a>
                        </li>
                        <?php endif ?>
                        <?= $this->getChildHtml('remember.me') ?>
                    </ul>
                </fieldset>
                <div class="buttons-set">
                    <button type="submit" class="button" title="<?= $this->quoteEscape($this->__('Login')) ?>" name="send" id="send2"><span><?= $this->__('Login') ?></span></button>
                    <?php if ($isMagicLinkEnabled && $magicLinkMode !== Mage_Customer_Model_Config_Registrationmode::MODE_NO_PASSWORD): ?>
                    <button type="button" class="button" title="<?= $this->quoteEscape($this->__('Login with Magic Link')) ?>" id="magic-link-button"><span><?= $this->__('Login with Magic Link') ?></span></button>
                    <?php endif ?>
                </div>
            </div>
        </div>
        <?php if (Mage::helper('checkout')->isContextCheckout()): ?>
            <input name="context" type="hidden" value="checkout" />
        <?php endif ?>
    </form>

    <?php if ($isRegistrationAllowed): ?>
    <div id="register-tab" class="tab-content">
        <?= $this->getChildHtml('register_form') ?>
    </div>
    <?php endif ?>

    <!-- Forgot Password Dialog -->
    <dialog id="forgot-password-dialog">
        <?= $this->getChildHtml('forgotpassword_form') ?>
    </dialog>

    <script type="text/javascript">
        var dataForm = new VarienForm('login-form', true);

        <?php if ($isMagicLinkEnabled && $magicLinkMode !== Mage_Customer_Model_Config_Registrationmode::MODE_NO_PASSWORD): ?>
        const form = document.getElementById('login-form');
        const passwordField = document.getElementById('pass');
        const loginButton = document.getElementById('send2');
        const magicLinkButton = document.getElementById('magic-link-button');

        // Regular login button - restore password validation classes
        loginButton?.addEventListener('click', function(e) {
            if (passwordField) {
                passwordField.classList.add('required-entry');
                passwordField.classList.add('validate-password');
            }
            form.action = '<?= $this->getPostActionUrl() ?>';
        });

        // Magic link button - remove password validation classes
        magicLinkButton?.addEventListener('click', function(e) {
            e.preventDefault();

            // Remove password validation classes
            if (passwordField) {
                passwordField.classList.remove('required-entry');
                passwordField.classList.remove('validate-password');
            }

            // Validate the form (will check email)
            if (dataForm.validator.validate()) {
                // Change form action to magic link request endpoint
                form.action = '<?= $this->getUrl('customer/account/magicLinkRequestPost') ?>';
                form.submit();
            }
        });
        <?php endif ?>

        // Forgot password dialog
        const showForgotLink = document.getElementById('show-forgot-password');
        const backToLoginLink = document.getElementById('back-to-login');
        const dialogCloseBtn = document.getElementById('dialog-close-btn');
        const forgotDialog = document.getElementById('forgot-password-dialog');

        showForgotLink?.addEventListener('click', function(e) {
            e.preventDefault();
            forgotDialog?.showModal();
        });

        backToLoginLink?.addEventListener('click', function(e) {
            e.preventDefault();
            forgotDialog?.close();
        });

        dialogCloseBtn?.addEventListener('click', function(e) {
            e.preventDefault();
            forgotDialog?.close();
        });

        <?php if ($showForgot): ?>
        // Auto-open forgot password dialog when accessed via /customer/account/forgotpassword
        forgotDialog?.showModal();
        <?php endif ?>
    </script>
</div>
