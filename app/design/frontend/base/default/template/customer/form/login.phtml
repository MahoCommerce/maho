<?php
/**
 * Maho
 *
 * @package     base_default
 * @copyright   Copyright (c) 2006-2020 Magento, Inc. (https://magento.com)
 * @copyright   Copyright (c) 2021-2023 The OpenMage Contributors (https://openmage.org)
 * @copyright   Copyright (c) 2024-2025 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/** @var Mage_Customer_Block_Form_Login $this */
?>
<?php $isRegistrationAllowed = $this->helper('customer')->isRegistrationAllowed() ?>
<div class="account-login<?php if (!$isRegistrationAllowed) echo ' login-only' ?>">
    <div class="page-title">
    <?php if ($isRegistrationAllowed): ?>
        <h1><?= $this->__('Login or Create an Account') ?></h1>
    <?php else: ?>
        <h1><?= $this->__('Login') ?></h1>
    <?php endif ?>
    </div>
    <?= $this->getMessagesBlock()->toHtml() ?>
    <?php /* Extensions placeholder */ ?>
    <?= $this->getChildHtml('customer.form.login.extra') ?>
    <?php $magicLinkMode = Mage::helper('customer')->getMagicLinkRegistrationMode(); ?>
    <?php $formAction = ($magicLinkMode === Mage_Customer_Model_Config_Registrationmode::MODE_NO_PASSWORD)
        ? $this->getUrl('customer/account/magicLinkRequestPost')
        : $this->getPostActionUrl(); ?>
    <form action="<?= $formAction ?>" method="post" id="login-form" aria-label="<?= $this->__('Login Form') ?>">
        <?= $this->getBlockHtml('formkey') ?>
        <div class="col2-set">
            <?php if ($isRegistrationAllowed): ?>
            <div class="col-1 new-users">
                <div class="content">
                    <h2><?= $this->__('New Customers') ?></h2>
                    <p><?= $this->__('By creating an account with our store, you will be able to move through the checkout process faster, store multiple shipping addresses, view and track your orders in your account and more.') ?></p>
                </div>
                <div class="buttons-set">
                    <a title="<?= $this->quoteEscape($this->__('Create an Account')) ?>" class="button" href="<?= $this->getCreateAccountUrlContext() ?>"><?= $this->__('Create an Account') ?></a>
                </div>
            </div>
            <?php endif ?>
            <?php // This column should be col-1 if the registration column is not displayed ?>
            <div class="<?= $isRegistrationAllowed ? 'col-2' : 'col-1'?> registered-users">
                <fieldset class="content fieldset">
                    <legend class="visually-hidden"><?= $this->__('Login Form') ?></legend>
                    <h2><?= $this->__('Registered Customers') ?></h2>
                    <p class="form-instructions"><?= $this->__('If you have an account with us, please log in.') ?></p>
                    <p class="required"><?= $this->__('* Required Fields') ?></p>
                    <ul class="form-list">
                        <li>
                            <label for="email" class="required" aria-label="<?= $this->__('Required') ?>"><?= $this->__('Email Address') ?></label>
                            <div class="input-box">
                                <input type="email" autocapitalize="off" autocorrect="off" spellcheck="false" name="login[username]" value="<?= $this->escapeHtml($this->getUsername()) ?>" id="email" class="input-text required-entry validate-email" title="<?= $this->quoteEscape($this->__('Email Address')) ?>" aria-required="true" />
                            </div>
                        </li>
                        <?php if ($magicLinkMode !== Mage_Customer_Model_Config_Registrationmode::MODE_NO_PASSWORD): ?>
                        <li>
                            <?php $minPasswordLength = $this->getMinPasswordLength(); ?>
                            <label for="pass" class="required" aria-label="<?= $this->__('Required') ?>"><?= $this->__('Password') ?></label>
                            <div class="input-box">
                                <input type="password" name="login[password]" class="input-text required-entry validate-password min-pass-length-<?= $minPasswordLength ?>" id="pass" title="<?= $this->quoteEscape($this->__('Password')) ?>" autocomplete="off" aria-required="true" />
                            </div>
                        </li>
                        <?php endif ?>
                        <?= $this->getChildHtml('form.additional.info') ?>
                        <?php if ($magicLinkMode !== Mage_Customer_Model_Config_Registrationmode::MODE_NO_PASSWORD): ?>
                        <li>
                            <a href="<?= $this->getForgotPasswordUrl() ?>" class="f-left"><?= $this->__('Forgot Your Password?') ?></a>
                        </li>
                        <?php endif ?>
                        <?= $this->getChildHtml('remember.me') ?>
                    </ul>
                </fieldset>
                <div class="buttons-set">
                    <button type="submit" class="button" title="<?= $this->quoteEscape($this->__('Login')) ?>" name="send" id="send2"><span><?= $this->__('Login') ?></span></button>
                    <?php if ($magicLinkMode !== Mage_Customer_Model_Config_Registrationmode::MODE_NO_PASSWORD && Mage::helper('customer')->isMagicLinkEnabled()): ?>
                    <button type="button" class="button" title="<?= $this->quoteEscape($this->__('Login with Magic Link')) ?>" id="magic-link-button"><span><?= $this->__('Login with Magic Link') ?></span></button>
                    <?php endif ?>
                </div>
            </div>
        </div>
        <?php if (Mage::helper('checkout')->isContextCheckout()): ?>
            <input name="context" type="hidden" value="checkout" />
        <?php endif ?>
    </form>
    <script type="text/javascript">
        var dataForm = new VarienForm('login-form', true);

        <?php if ($magicLinkMode !== Mage_Customer_Model_Config_Registrationmode::MODE_NO_PASSWORD && Mage::helper('customer')->isMagicLinkEnabled()): ?>
        document.getElementById('magic-link-button')?.addEventListener('click', function(e) {
            e.preventDefault();

            const form = document.getElementById('login-form');
            const passwordField = document.getElementById('pass');

            // Change form action to magic link request endpoint
            form.action = '<?= $this->getUrl('customer/account/magicLinkRequestPost') ?>';

            // Remove password validation requirements
            if (passwordField) {
                passwordField.removeAttribute('required');
                passwordField.setAttribute('aria-required', 'false');
                passwordField.classList.remove('required-entry');
                passwordField.classList.remove('validate-password');
            }

            // Submit the form
            form.submit();
        });
        <?php endif ?>
    </script>
</div>
