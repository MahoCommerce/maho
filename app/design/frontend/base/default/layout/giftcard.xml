<?xml version="1.0"?>
<!--
/**
 * Maho
 *
 * @category   Maho
 * @package    Maho_Giftcard
 * @copyright  Copyright (c) 2025-2026 Maho (https://mahocommerce.com)
 * @license    https://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */
-->
<layout>
    <!-- Checkout Payment - Add gift card form and handle payment method selection -->
    <checkout_onepage_index>
        <!-- Add gift card form BEFORE the payment form (before_form is rendered before the form starts) -->
        <reference name="checkout.onepage.payment.before_form">
            <block type="giftcard/checkout_payment_giftcard" name="checkout.payment.giftcard" template="maho/giftcard/checkout/payment/giftcard.phtml" />
        </reference>
        <!-- Handle payment method visibility based on gift card coverage -->
        <reference name="checkout.onepage.payment.methods">
            <block type="core/template" name="giftcard.payment.methods" template="maho/giftcard/checkout/payment/methods.phtml" />
        </reference>
    </checkout_onepage_index>

    <!-- Checkout Payment Method AJAX Load - Only add JS handler, not the form (form is already in methods_additional) -->
    <checkout_onepage_paymentmethod>
        <reference name="root">
            <block type="core/template" name="giftcard.payment.methods.ajax" template="maho/giftcard/checkout/payment/methods.phtml" />
        </reference>
    </checkout_onepage_paymentmethod>

    <!-- Checkout Cart - Add Gift Card Form -->
    <checkout_cart_index>
        <!-- Add to the extra section where discount codes appear -->
        <reference name="checkout.cart.extra">
            <block type="giftcard/checkout_cart_giftcard" name="checkout.cart.giftcard" as="giftcard" template="maho/giftcard/checkout/cart/giftcard.phtml" />
        </reference>
    </checkout_cart_index>

    <!-- Sales Order View - Add gift card totals -->
    <sales_order_view>
        <reference name="order_totals">
            <block type="giftcard/sales_order_totals" name="giftcard" />
        </reference>
    </sales_order_view>

    <!-- Sales Order Print - Add gift card totals -->
    <sales_order_print>
        <reference name="order_totals">
            <block type="giftcard/sales_order_totals" name="giftcard" />
        </reference>
    </sales_order_print>

    <!-- Sales Order Invoice View - Add gift card totals -->
    <sales_order_invoice>
        <reference name="invoice_totals">
            <block type="giftcard/sales_order_totals" name="giftcard" />
        </reference>
    </sales_order_invoice>

    <!-- Sales Order Creditmemo View - Add gift card totals -->
    <sales_order_creditmemo>
        <reference name="creditmemo_totals">
            <block type="giftcard/sales_order_totals" name="giftcard" />
        </reference>
    </sales_order_creditmemo>

    <!-- Sales Order Email - Add gift card totals -->
    <sales_email_order_items>
        <reference name="order_totals">
            <block type="giftcard/sales_order_totals" name="giftcard" />
        </reference>
    </sales_email_order_items>

    <!-- Sales Invoice Email - Add gift card totals -->
    <sales_email_order_invoice_items>
        <reference name="invoice_totals">
            <block type="giftcard/sales_order_totals" name="giftcard" />
        </reference>
    </sales_email_order_invoice_items>

    <!-- Sales Creditmemo Email - Add gift card totals -->
    <sales_email_order_creditmemo_items>
        <reference name="creditmemo_totals">
            <block type="giftcard/sales_order_totals" name="giftcard" />
        </reference>
    </sales_email_order_creditmemo_items>

    <!-- Gift Card Product View -->
    <PRODUCT_TYPE_giftcard>
        <reference name="product.info">
            <block type="giftcard/catalog_product_view_type_giftcard" name="product.info.giftcard" as="product_type_data" template="catalog/product/view/type/default.phtml">
                <block type="core/text_list" name="product.info.giftcard.extra" as="product_type_data_extra" translate="label">
                    <label>Product Extra Info</label>
                </block>
            </block>
        </reference>
        <reference name="product.info.options.wrapper">
            <block type="giftcard/catalog_product_view_type_giftcard" name="product.info.options.giftcard" as="options_giftcard" before="-" template="maho/giftcard/catalog/product/view/type/options/giftcard.phtml" />
        </reference>
    </PRODUCT_TYPE_giftcard>
</layout>
