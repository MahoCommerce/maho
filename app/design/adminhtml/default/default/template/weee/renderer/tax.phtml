<?php
/**
 * Maho
 *
 * @package     default_default
 * @copyright   Copyright (c) 2006-2020 Magento, Inc. (https://magento.com)
 * @copyright   Copyright (c) 2021-2025 The OpenMage Contributors (https://openmage.org)
 * @copyright   Copyright (c) 2024-2026 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/** @var Mage_Weee_Block_Renderer_Weee_Tax $this */
?>
<?php $_htmlId      = $this->getElement()->getHtmlId() ?>
<?php $_htmlClass   = $this->getElement()->getClass() ?>
<?php $_htmlName    = $this->getElement()->getName() ?>
<?php $_multiWebsite = $this->isMultiWebsites(); ?>
<tr>
    <td class="label"><?= $this->getElement()->getLabel() ?></td>
    <td colspan="10" class="grid weee">
    <table cellspacing="0" class="data border" id="<?= $_htmlId ?>_table">
        <?php if ($_multiWebsite): ?>
        <col width="135" />
        <?php endif ?>
        <col width="140" />
        <col />
        <col width="1" />
        <thead>
            <tr class="headings">
                <th <?php if (!$_multiWebsite): ?>style="display:none"<?php endif ?>><?= Mage::helper('sales')->__('Website') ?></th>
                <th><?= Mage::helper('catalog')->__('Country/State') ?> <span class="required">*</span></th>
                <th><?= Mage::helper('catalog')->__('Tax') ?> <span class="required">*</span></th>
                <th class="last"><?= Mage::helper('catalog')->__('Action') ?></th>
            </tr>
            <tr id="<?= $_htmlId ?>_add_template" class="template no-display">
                <td <?php if (!$_multiWebsite): ?>style="display:none"<?php endif ?>>
                <select disabled="no-template" class="<?= $_htmlClass ?> required-entry" name="<?= $_htmlName ?>[__index__][website_id]" id="#{prefix}_weee_tax_row___index___website">
                    <?php foreach ($this->getWebsites() as $_websiteId => $_info): ?>
                    <option value="<?= $_websiteId ?>"><?= $_info['name'] ?><?php if (!empty($_info['currency'])): ?> [<?= $_info['currency'] ?>]<?php endif ?></option>
                    <?php endforeach ?>
                </select>
                </td>
                <td class="nobr">
                <select disabled="no-template" class="<?= $_htmlClass ?> country required-entry" name="<?= $_htmlName ?>[__index__][country]" id="#{prefix}_weee_tax_row___index___country">
                    <?php foreach ($this->getCountries() as $_country): ?>
                    <option value="<?= $_country['value'] ?>"><?= htmlspecialchars($_country['label']) ?></option>
                    <?php endforeach ?>
                </select>
                <br />
                <select disabled="no-template" class="<?= $_htmlClass ?> state" name="<?= $_htmlName ?>[__index__][state]" id="#{prefix}_weee_tax_row___index___state">
                    <option value="0">*</option>
                </select>
                </td>
                <td>
                    <input disabled="no-template" class="<?= $_htmlClass ?> required-entry validate-greater-than-zero" type="text" name="<?= $_htmlName ?>[__index__][price]" value="'#{price}'" />
                </td>
                <td class="last">
                    <input type="hidden" name="<?= $_htmlName ?>[__index__][delete]" class="delete" disabled="no-template" value=""  id="#{prefix}_weee_tax_row___index___delete" />
                    <button title="Delete WEEE Tax" class="scalable delete icon-btn delete-product-option" onclick="weeeTaxControl.deleteItem('<?= $_htmlId ?>', event);return false"><span>Delete</span></button>
                </td>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <td <?php if (!$_multiWebsite): ?>style="display:none"<?php endif ?>></td>
                <td colspan="3" class="a-right"><?= $this->getAddButtonHtml() ?></td>
            </tr>
        </tfoot>
        <tbody id="<?= $_htmlId ?>_container">
        </tbody>
    </table>

<script type="text/javascript">
    window.itemsCount = window.itemsCount ?? 0;

    const weeeTaxControl = {
        deleteButton: false,

        addItem() {
            const data = {
                prefix: '',
                website_id: 0,
                country: '',
                state: '',
                price: '',
                index: itemsCount++
            };

            if (arguments.length === 5) {
                data.prefix = arguments[0];
                data.website_id = arguments[1];
                data.country = arguments[2];
                data.state = arguments[3];
                data.price = arguments[4];
            } else if (arguments.length === 1) {
                data.prefix = arguments[0];
            }

            const templateElement = document.getElementById(`${data.prefix}_add_template`);
            let templateHtml = templateElement.innerHTML
                .replace(/__index__/g, data.index)
                .replace(/ disabled="?no-template"?/g, '')
                .replace(/ disabled/g, '')
                .replace(/="'([^']*)'"/, '="$1"')
                .replace(/#{prefix}/g, data.prefix)
                .replace(/#{price}/g, data.price);

            const newRow = document.createElement('tr');
            newRow.innerHTML = templateHtml;

            const container = document.getElementById(`${data.prefix}_container`);
            container.appendChild(newRow);

            const countrySelect = document.getElementById(`${data.prefix}_weee_tax_row_${data.index}_country`);
            const websiteSelect = document.getElementById(`${data.prefix}_weee_tax_row_${data.index}_website`);

            if (countrySelect) countrySelect.value = data.country;
            if (websiteSelect) websiteSelect.value = data.website_id;

            // Initialize region updater
            const updater = new RegionUpdater(
                `${data.prefix}_weee_tax_row_${data.index}_country`,
                null,
                `${data.prefix}_weee_tax_row_${data.index}_state`,
                <?= Mage::helper('directory')->getRegionJsonByStore() ?>,
                'disable',
                true
            );
            updater.update();

            const stateSelect = document.getElementById(`${data.prefix}_weee_tax_row_${data.index}_state`);
            if (stateSelect) stateSelect.value = data.state;
        },

        deleteItem(prefix, event) {
            const tr = event.target.closest('tr');
            if (tr) {
                // Mark delete inputs as 1
                tr.querySelectorAll('.delete').forEach(elem => {
                    elem.value = '1';
                });

                // Hide all inputs and selects
                tr.querySelectorAll('input, select').forEach(elem => {
                    elem.style.display = 'none';
                });

                // Hide the row and add classes
                tr.style.display = 'none';
                tr.classList.add('no-display', 'template');
            }
        },

        priceTypeChangeEventObserver() {
            const priceTypeElement = document.getElementById('price_type');
            if (!priceTypeElement) return;

            const val = priceTypeElement.value;

            for (let i = 0; i < weeeEditorPrefixes.length; i++) {
                const tableElement = document.getElementById(`${weeeEditorPrefixes[i]}_table`);
                if (!tableElement) continue;

                const parentElement = tableElement.closest('td');
                if (val != 1) {
                    if (parentElement) parentElement.style.display = 'none';
                    weeeTaxControl.disableEditElements(weeeEditorPrefixes[i]);
                } else {
                    weeeTaxControl.enableEditElements(weeeEditorPrefixes[i]);
                    if (parentElement) parentElement.style.display = '';
                }
            }
        },

        bindPriceTypeChangeObserver() {
            const priceTypeElement = document.getElementById('price_type');
            if (priceTypeElement) {
                priceTypeElement.addEventListener('change', weeeTaxControl.priceTypeChangeEventObserver);
                weeeTaxControl.priceTypeChangeEventObserver();
            }
        },

        enableEditElements(prefix) {
            const container = document.getElementById(`${prefix}_container`);
            if (!container) return;

            const nodes = container.children;
            for (let a = 0; a < nodes.length; a++) {
                const tr = nodes[a];
                tr.querySelectorAll('input, select').forEach(elem => {
                    elem.disabled = weeeEditorState[elem.id] || false;
                    if (elem.id.includes('delete')) {
                        elem.value = (typeof weeeEditorDeleted[elem.id] === 'undefined' || !weeeEditorDeleted[elem.id]) ? '0' : '1';
                    }
                });
            }
        },

        disableEditElements(prefix) {
            const container = document.getElementById(`${prefix}_container`);
            if (!container) return;

            const nodes = container.children;
            for (let b = 0; b < nodes.length; b++) {
                const tr = nodes[b];
                tr.querySelectorAll('input, select').forEach(elem => {
                    if (elem.id.includes('delete')) {
                        weeeEditorDeleted[elem.id] = elem.value || '0';
                        elem.value = '1';
                    }
                    weeeEditorState[elem.id] = elem.disabled;
                    elem.disabled = true;
                });
            }
        }
    };

    <?php foreach ($this->getValues() as $_item): ?>
    weeeTaxControl.addItem('<?= $_htmlId ?>', '<?= $_item['website_id'] ?>', '<?= $_item['country'] ?>', '<?= $_item['state'] ?>', '<?= sprintf('%.2f', $_item['value']) ?>');
    <?php endforeach ?>

    if (typeof weeeEditorPrefixes === 'undefined') {
        window.weeeEditorPrefixes = [];
        window.weeeEditorState = {};
        window.weeeEditorDeleted = {};
        document.addEventListener('DOMContentLoaded', weeeTaxControl.bindPriceTypeChangeObserver);
    }
    weeeEditorPrefixes.push('<?= $_htmlId ?>');
</script>
</td>
</tr>
