<?php
/**
 * Maho
 *
 * @package     default_default
 * @copyright   Copyright (c) 2006-2020 Magento, Inc. (https://magento.com)
 * @copyright   Copyright (c) 2022 The OpenMage Contributors (https://openmage.org)
 * @copyright   Copyright (c) 2025 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<script type="text/javascript">
class CountryModel {
    constructor() {
        this.reload = false;
        this.bindSpecificCountryRelation();
        this.observeNewShippingMethods();
    }

    bindSpecificCountryRelation(parentId) {
        let selector = parentId ?
            `#${parentId} .shipping-applicable-country` :
            '.shipping-applicable-country';

        const applyCountryElements = document.querySelectorAll(selector);

        applyCountryElements.forEach(element => {
            element.addEventListener('change', (event) => this.checkSpecificCountry(event));
            this.initSpecificCountry(element);
        });
    }

    initSpecificCountry(element) {
        if (!element?.id) return;

        const specifCountryElement = document.getElementById(element.id.replace(/sallowspecific/, 'specificcountry'));

        if (!specifCountryElement) return;

        if (element.value == 1) {
            // If specific country element selected
            specifCountryElement.disabled = false;
        } else {
            specifCountryElement.disabled = true;
        }
    }

    checkSpecificCountry(event) {
        const applyCountryElement = event.target;

        if (!applyCountryElement?.id) return;

        const specifCountryElement = document.getElementById(applyCountryElement.id.replace(/sallowspecific/, 'specificcountry'));

        if (!specifCountryElement) return;

        if (applyCountryElement.value == 1) {
            // If specific country element selected
            specifCountryElement.disabled = false;
        } else {
            this.unselectSpecificCountry(specifCountryElement);
            specifCountryElement.disabled = true;
        }
    }

    unselectSpecificCountry(element) {
        Array.from(element.options).forEach(option => {
            if (option.selected) {
                option.selected = false;
            }
        });
    }

    observeNewShippingMethods() {
        // Track which elements we've already initialized
        this.initializedElements = new Set();

        // Find and observe all shipping method enable/disable elements
        document.querySelectorAll('select[id*="carriers_"][id$="_active"]').forEach(activeElement => {
            activeElement.addEventListener('change', (event) => {
                // When a shipping method is enabled, initialize its country elements
                if (event.target.value == '1') {
                    // Find the corresponding applicable country element
                    const carrierName = event.target.id.replace('_active', '');
                    const applicableCountryElement = document.getElementById(carrierName + '_sallowspecific');

                    if (applicableCountryElement) {
                        // Add event listener if not already added
                        if (!this.initializedElements.has(applicableCountryElement.id)) {
                            applicableCountryElement.addEventListener('change', (event) => this.checkSpecificCountry(event));
                            this.initializedElements.add(applicableCountryElement.id);
                        }

                        // Initialize the country selection logic
                        this.initSpecificCountry(applicableCountryElement);
                    }
                }
            });
        });
    }
}

const countryApply = new CountryModel();
</script>
