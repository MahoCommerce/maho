<?php
/**
 * Maho
 *
 * @package     default_default
 * @copyright   Copyright (c) 2006-2020 Magento, Inc. (https://magento.com)
 * @copyright   Copyright (c) 2022-2024 The OpenMage Contributors (https://openmage.org)
 * @copyright   Copyright (c) 2024-2026 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/** @var Mage_Adminhtml_Block_Template $this */
?>
<script type="text/javascript">
class OriginModel {
    constructor() {
        this.reload = false;
        this.regionsUrl = "<?= $this->getUrl('*/json/countryRegion') ?>";
        this.bindCountryRegionRelation();
    }

    bindCountryRegionRelation(parentId) {
        let countryElements;
        if (parentId) {
            countryElements = document.querySelectorAll('#' + parentId + ' .countries');
        } else {
            countryElements = document.querySelectorAll('.countries');
        }

        countryElements.forEach(element => {
            element.addEventListener('change', (event) => this.reloadRegionField(event));
            this.initRegionField(element);

            const inheritElement = document.getElementById(element.id + '_inherit');
            if (inheritElement) {
                inheritElement.addEventListener('change', (event) => this.enableRegionZip(event));
            }
        });
    }

    enableRegionZip(event) {
        this.reload = true;
        const countryElement = event.target;
        if (countryElement && countryElement.id && !countryElement.checked) {
            const regionElement = document.getElementById(countryElement.id.replace(/country_id/, 'region_id'));
            const zipElement = document.getElementById(countryElement.id.replace(/country_id/, 'postcode'));
            if (regionElement && regionElement.checked) {
                regionElement.click();
            }
            if (zipElement && zipElement.checked) {
                zipElement.click();
            }
        }
    }

    initRegionField(element) {
        const countryElement = element;
        if (countryElement && countryElement.id) {
            const regionElement = document.getElementById(countryElement.id.replace(/country_id/, 'region_id'));
            if (regionElement) {
                this.regionElement = regionElement;
                // Load regions if country has a value
                if (countryElement.value && countryElement.value !== '') {
                    const url = this.regionsUrl + 'parent/' + countryElement.value;
                    this.loadRegions(url);
                }
            }
        }
    }

    reloadRegionField(event) {
        this.reload = true;
        const countryElement = event.target;
        if (countryElement && countryElement.id) {
            const regionElement = document.getElementById(countryElement.id.replace(/country_id/, 'region_id'));
            if (regionElement) {
                this.regionElement = regionElement;
                const url = this.regionsUrl + 'parent/' + countryElement.value;
                this.loadRegions(url);
            }
        }
    }

    loadRegions(url) {
        mahoFetch(url)
            .then(data => {
                data = JSON.parse(data);
                this.refreshRegionField(data);
            })
            .catch(error => {
                console.error('Error loading regions:', error);
            });
    }

    refreshRegionField(data) {
        if (data) {
            const value = this.regionElement.value;
            const disabled = this.regionElement.disabled;
            if (data.length) {
                let html = `<select name="${this.regionElement.name}" id="${this.regionElement.id}" class="required-entry select" title="${this.regionElement.title}"${disabled ? ' disabled' : ''}>`;

                data.forEach(region => {
                    if (region.label) {
                        const selected = (value && (value == region.value || value === region.label)) ? ' selected' : '';
                        html += `<option value="${region.value}"${selected}>${region.label}</option>`;
                    }
                });
                html += '</select>';

                const parentNode = this.regionElement.parentNode;
                const regionElementId = this.regionElement.id;
                parentNode.innerHTML = html;
                this.regionElement = document.getElementById(regionElementId);
            } else if (this.reload) {
                const html = `<input type="text" name="${this.regionElement.name}" id="${this.regionElement.id}" class="input-text" title="${this.regionElement.title}"${disabled ? ' disabled' : ''}>`;
                const parentNode = this.regionElement.parentNode;
                const regionElementId = this.regionElement.id;
                parentNode.innerHTML = html;
                this.regionElement = document.getElementById(regionElementId);
            }
        }
    }
}

const originAddress = new OriginModel();
</script>
