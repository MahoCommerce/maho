<?php
/**
 * Maho
 *
 * @package     default_default
 * @copyright   Copyright (c) 2006-2020 Magento, Inc. (https://magento.com)
 * @copyright   Copyright (c) 2021-2025 The OpenMage Contributors (https://openmage.org)
 * @copyright   Copyright (c) 2024-2025 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/** @var Mage_Adminhtml_Block_System_Config_Form_Field_Array_Abstract $this */
?>

<?php
$_htmlId = $this->getHtmlId() ? $this->getHtmlId() : '_' . uniqid();

$_colspan = 2;
if (!$this->_addAfter) {
    $_colspan -= 1;
}
$_colspan = $_colspan > 1 ? 'colspan="' . $_colspan . '"' : '';
?>

<div class="grid" id="grid<?= $_htmlId ?>">
    <table cellpadding="0" cellspacing="0" class="border">
        <tbody>

            <tr class="headings" id="headings<?= $_htmlId ?>">
<?php foreach ($this->_columns as $columnName => $column):?>
                <th><?= $column['label'] ?></th>
<?php endforeach ?>
                <th <?= $_colspan ?>></th>
            </tr>

            <tr id="addRow<?= $_htmlId ?>">
                <td colspan="<?= count($this->_columns) ?>"></td>
                <td <?= $_colspan ?>>
                    <button style="" onclick="" class="scalable add" type="button" id="addToEndBtn<?= $_htmlId ?>">
                        <span><?= $this->_addButtonLabel ?></span>
                    </button>
                </td>
            </tr>

        </tbody>
    </table>
    <input type="hidden" name="<?= $this->getElement()->getName() ?>[__empty]" value="" />
</div>
<div id="empty<?= $_htmlId ?>">
    <button style="" onclick="" class="scalable add" type="button" id="emptyAddBtn<?= $_htmlId ?>">
        <span><?= $this->_addButtonLabel ?></span>
    </button>
</div>

<script type="text/javascript">
const arrayRow<?= $_htmlId ?> = {
    // Define row template using template literals
    template: function(data) {
        return `<tr id="${data._id}">
<?php foreach ($this->_columns as $columnName => $column):?>
            <td><?= $this->jsQuoteEscape($this->_renderCellTemplate($columnName)) ?></td>
<?php endforeach ?>
<?php if ($this->_addAfter):?>
            <td><button class="scalable add" type="button" id="addAfterBtn${data._id}"><span><?= $this->jsQuoteEscape(Mage::helper('adminhtml')->__('Add after')) ?></span></button></td>
<?php endif ?>
            <td><button onclick="arrayRow<?= $_htmlId ?>.del('${data._id}')" class="scalable delete" type="button"><span><?= $this->jsQuoteEscape(Mage::helper('adminhtml')->__('Delete')) ?></span></button></td>
        </tr>`;
    },

    rowsCount: 0,

    add: function(templateData, insertAfterId) {
        // Generate default template data
        if (!templateData || templateData === '') {
            const d = new Date();
            templateData = {
<?php foreach ($this->_columns as $columnName => $column):?>
                <?= $columnName ?>: '',
<?php endforeach ?>
                _id: '_' + d.getTime() + '_' + d.getMilliseconds()
            };
        }

        const htmlContent = this.template(templateData);

        // Insert before last row
        if (!insertAfterId || insertAfterId === '') {
            const addRow = document.getElementById('addRow<?= $_htmlId ?>');
            if (addRow) {
                addRow.insertAdjacentHTML('beforebegin', htmlContent);
            }
        }
        // Insert after specified row
        else {
            const afterRow = document.getElementById(insertAfterId);
            if (afterRow) {
                afterRow.insertAdjacentHTML('afterend', htmlContent);
            }
        }

<?php if ($this->_addAfter):?>
        const addAfterBtn = document.getElementById('addAfterBtn' + templateData._id);
        if (addAfterBtn) {
            addAfterBtn.addEventListener('click', () => this.add('', templateData._id));
        }
<?php endif ?>

        this.rowsCount += 1;
    },

    del: function(rowId) {
        const row = document.getElementById(rowId);
        if (row) {
            row.remove();
        }
        this.rowsCount -= 1;
        if (this.rowsCount === 0) {
            this.showButtonOnly();
        }
    },

    showButtonOnly: function() {
        const grid = document.getElementById('grid<?= $_htmlId ?>');
        const empty = document.getElementById('empty<?= $_htmlId ?>');
        if (grid) grid.style.display = 'none';
        if (empty) empty.style.display = '';
    }
};

document.addEventListener('DOMContentLoaded', function() {
    // Bind add action to "Add" button in last row
    const addToEndBtn = document.getElementById('addToEndBtn<?= $_htmlId ?>');
    if (addToEndBtn) {
        addToEndBtn.addEventListener('click', () => arrayRow<?= $_htmlId ?>.add('', ''));
    }

    // Add existing rows
    <?php
    $_addAfterId = "headings{$_htmlId}";
    foreach ($this->getArrayRows() as $_rowId => $_row) {
        echo "arrayRow{$_htmlId}.add(" . $_row->toJson() . ", '{$_addAfterId}');\n";
        $_addAfterId = $_rowId;
    }
    ?>

    // Initialize standalone button
    const emptyDiv = document.getElementById('empty<?= $_htmlId ?>');
    if (emptyDiv) {
        emptyDiv.style.display = 'none';
    }

    const emptyAddBtn = document.getElementById('emptyAddBtn<?= $_htmlId ?>');
    if (emptyAddBtn) {
        emptyAddBtn.addEventListener('click', function() {
            const grid = document.getElementById('grid<?= $_htmlId ?>');
            const empty = document.getElementById('empty<?= $_htmlId ?>');
            if (grid) grid.style.display = '';
            if (empty) empty.style.display = 'none';
            arrayRow<?= $_htmlId ?>.add('', '');
        });
    }

    // If no rows, hide grid and show button only
    <?php if (!$this->getArrayRows()):?>
    arrayRow<?= $_htmlId ?>.showButtonOnly();
    <?php endif ?>

    // Toggle the grid, if element is disabled (depending on scope)
    <?php if ($this->getElement()->getDisabled()):?>
    const gridElement = document.getElementById('grid<?= $_htmlId ?>');
    if (gridElement && typeof toggleValueElements === 'function') {
        toggleValueElements({checked: true}, gridElement.parentNode);
    }
    <?php endif ?>
});
</script>
