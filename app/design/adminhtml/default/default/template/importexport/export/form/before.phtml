<?php
/**
 * Maho
 *
 * @package     default_default
 * @copyright   Copyright (c) 2006-2020 Magento, Inc. (https://magento.com)
 * @copyright   Copyright (c) 2022-2025 The OpenMage Contributors (https://openmage.org)
 * @copyright   Copyright (c) 2024-2026 Maho (https://mahocommerce.com)
 * @license     https://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/** @var Mage_Adminhtml_Block_Template $this */
?>
<script type="text/javascript">
//<![CDATA[
    /**
     * Post form data and process response via AJAX.
     *
     * @return void
     */
    varienForm.prototype.getFilter = function()
    {
        const entityElement = document.getElementById('entity');
        if (entityElement && entityElement.value) {
            let url = "<?= $this->getUrl('*/*/getFilter') ?>";
            url += ((url.slice(-1) !== '/') ? '/' : '') + 'entity/' + entityElement.value;

            mahoFetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            })
            .then(responseText => {
                const cleanedResponse = responseText.replace(/>\s+</g, '><');
                const container = document.getElementById('export_filter_grid_container');
                if (container) {
                    container.innerHTML = cleanedResponse;
                }
                const filterContainer = document.getElementById('export_filter_container');
                if (filterContainer) {
                    filterContainer.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Filter request failed:', error);
            });
        } else {
            const filterContainer = document.getElementById('export_filter_container');
            if (filterContainer) {
                filterContainer.style.display = 'none';
            }
        }
    };

    /**
     * Continue export process after filter settings.
     *
     * return void
     */
    function getFile()
    {
        const entityElement = document.getElementById('entity');
        const fileFormatElement = document.getElementById('file_format');

        if (entityElement && fileFormatElement) {
            const form = document.getElementById('export_filter_form');
            const oldAction = form.action;

            // Add entity and file_format as hidden inputs to the filter form
            const entityInput = document.createElement('input');
            entityInput.type = 'hidden';
            entityInput.name = 'entity';
            entityInput.value = entityElement.value;
            form.appendChild(entityInput);

            const fileFormatInput = document.createElement('input');
            fileFormatInput.type = 'hidden';
            fileFormatInput.name = 'file_format';
            fileFormatInput.value = fileFormatElement.value;
            form.appendChild(fileFormatInput);

            // Submit the complete form with all filter data
            form.action = '<?= $this->getUrl('*/*/export') ?>';
            form.submit();
            form.action = oldAction;
        } else {
            alert('<?= $this->jsQuoteEscape($this->__('Invalid data')) ?>');
        }
    }
//]]>
</script>
