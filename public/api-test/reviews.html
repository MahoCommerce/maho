<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviews API Tests - Maho API Test Harness</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div x-data="reviewTests()" class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <a href="index.html" class="text-blue-400 hover:text-blue-300 text-sm">&larr; Back to Dashboard</a>
            <h1 class="text-3xl font-bold text-white mt-2">Reviews API Tests</h1>
            <p class="text-gray-400">Test product reviews and ratings endpoints</p>
        </header>

        <!-- API Endpoints Reference -->
        <div class="bg-gray-800 rounded-lg p-4 mb-8">
            <h2 class="text-lg font-semibold mb-3">API Endpoints</h2>
            <div class="text-sm font-mono text-gray-300">
                <ul class="space-y-1">
                    <li>GET /api/products/{id}/reviews - Get product reviews</li>
                    <li>POST /api/products/{id}/reviews - Submit review</li>
                    <li>GET /api/reviews/{id} - Get single review</li>
                    <li>GET /api/customers/me/reviews - Customer's reviews (auth required)</li>
                </ul>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button @click="activeTab = 'product'"
                    :class="activeTab === 'product' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">Product Reviews</button>
            <button @click="activeTab = 'submit'"
                    :class="activeTab === 'submit' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">Submit Review</button>
            <button @click="activeTab = 'customer'"
                    :class="activeTab === 'customer' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">My Reviews</button>
        </div>

        <!-- Product Reviews Tab -->
        <div x-show="activeTab === 'product'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Product Reviews</h3>

                <div class="flex gap-2 mb-4">
                    <input type="text" x-model="product.id" placeholder="Product ID (e.g., 123)"
                           @keyup.enter="loadReviews()"
                           class="flex-1 bg-gray-700 rounded px-3 py-2">
                    <button @click="loadReviews()"
                            :disabled="loading || !product.id"
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Load Reviews
                    </button>
                </div>
            </div>

            <!-- Reviews Summary -->
            <div x-show="product.summary" class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-6 mb-6">
                    <div class="text-center">
                        <div class="text-4xl font-bold" x-text="product.summary.averageRating?.toFixed(1) || '-'"></div>
                        <div class="flex justify-center mt-1">
                            <template x-for="i in 5" :key="i">
                                <svg class="w-5 h-5" :class="i <= Math.round(product.summary.averageRating || 0) ? 'text-yellow-400' : 'text-gray-600'" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                            </template>
                        </div>
                        <div class="text-sm text-gray-400 mt-1" x-text="(product.summary.totalReviews || 0) + ' reviews'"></div>
                    </div>

                    <!-- Rating Breakdown -->
                    <div class="flex-1 space-y-1">
                        <template x-for="rating in [5, 4, 3, 2, 1]" :key="rating">
                            <div class="flex items-center gap-2 text-sm">
                                <span class="w-3" x-text="rating"></span>
                                <div class="flex-1 bg-gray-700 rounded-full h-2 overflow-hidden">
                                    <div class="bg-yellow-400 h-full" :style="'width: ' + ((product.summary.ratingBreakdown?.[rating] || 0) / (product.summary.totalReviews || 1) * 100) + '%'"></div>
                                </div>
                                <span class="w-8 text-gray-500 text-xs" x-text="product.summary.ratingBreakdown?.[rating] || 0"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Reviews List -->
            <div x-show="product.reviews" class="space-y-4">
                <template x-for="review in product.reviews" :key="review.id">
                    <div class="bg-gray-800 rounded-lg p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h4 class="font-semibold" x-text="review.title || review.summary"></h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="flex">
                                        <template x-for="i in 5" :key="i">
                                            <svg class="w-4 h-4" :class="i <= (review.rating || review.ratingValue) ? 'text-yellow-400' : 'text-gray-600'" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                            </svg>
                                        </template>
                                    </div>
                                    <span class="text-sm text-gray-400" x-text="review.nickname || review.customerName || 'Anonymous'"></span>
                                </div>
                            </div>
                            <span class="text-xs text-gray-500" x-text="review.createdAt || review.date"></span>
                        </div>
                        <p class="text-gray-300 text-sm" x-text="review.detail || review.content || review.text"></p>
                        <div x-show="review.status" class="mt-2">
                            <span class="text-xs px-2 py-0.5 rounded"
                                  :class="review.status === 'approved' ? 'bg-green-900 text-green-300' :
                                          review.status === 'pending' ? 'bg-yellow-900 text-yellow-300' : 'bg-red-900 text-red-300'"
                                  x-text="review.status"></span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Raw Response -->
            <div x-show="product.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="product.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- Submit Review Tab -->
        <div x-show="activeTab === 'submit'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Submit Review</h3>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Product ID</label>
                        <input type="text" x-model="submit.productId" placeholder="Product ID"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Your Name</label>
                        <input type="text" x-model="submit.nickname" placeholder="Nickname"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Rating</label>
                        <div class="flex gap-2">
                            <template x-for="i in 5" :key="i">
                                <button @click="submit.rating = i"
                                        class="p-1 hover:scale-110 transition">
                                    <svg class="w-8 h-8" :class="i <= submit.rating ? 'text-yellow-400' : 'text-gray-600'" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                </button>
                            </template>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Review Title</label>
                        <input type="text" x-model="submit.title" placeholder="Summary of your review"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Review</label>
                        <textarea x-model="submit.detail" placeholder="Write your review..."
                                  rows="4" class="w-full bg-gray-700 rounded px-3 py-2"></textarea>
                    </div>

                    <button @click="submitReview()"
                            :disabled="loading || !submit.productId || !submit.rating || !submit.detail"
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Submit Review
                    </button>
                </div>
            </div>

            <!-- Submit Result -->
            <div x-show="submit.result" class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl" x-text="submit.success ? '✓' : '✗'"></span>
                    <span class="font-semibold" :class="submit.success ? 'text-green-400' : 'text-red-400'"
                          x-text="submit.success ? 'Review submitted!' : 'Failed to submit'"></span>
                </div>
                <p class="text-gray-400" x-text="submit.message"></p>
            </div>

            <!-- Raw Response -->
            <div x-show="submit.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="submit.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- My Reviews Tab -->
        <div x-show="activeTab === 'customer'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">My Reviews</h3>
                <p class="text-gray-400 text-sm mb-4">Requires authentication. Login first to see your reviews.</p>

                <button @click="loadMyReviews()"
                        :disabled="loading"
                        class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                    Load My Reviews
                </button>
            </div>

            <!-- My Reviews List -->
            <div x-show="myReviews.reviews" class="space-y-4">
                <div class="text-gray-400 mb-2">
                    Found <span class="font-semibold" x-text="myReviews.total"></span> reviews
                </div>

                <template x-for="review in myReviews.reviews" :key="review.id">
                    <div class="bg-gray-800 rounded-lg p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h4 class="font-semibold" x-text="review.title || review.summary"></h4>
                                <p class="text-sm text-gray-400" x-text="'Product: ' + (review.productName || review.productId)"></p>
                                <div class="flex mt-1">
                                    <template x-for="i in 5" :key="i">
                                        <svg class="w-4 h-4" :class="i <= (review.rating || review.ratingValue) ? 'text-yellow-400' : 'text-gray-600'" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                        </svg>
                                    </template>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs px-2 py-0.5 rounded"
                                      :class="review.status === 'approved' ? 'bg-green-900 text-green-300' :
                                              review.status === 'pending' ? 'bg-yellow-900 text-yellow-300' : 'bg-red-900 text-red-300'"
                                      x-text="review.status || 'pending'"></span>
                                <div class="text-xs text-gray-500 mt-1" x-text="review.createdAt || review.date"></div>
                            </div>
                        </div>
                        <p class="text-gray-300 text-sm" x-text="review.detail || review.content"></p>
                    </div>
                </template>
            </div>

            <!-- Raw Response -->
            <div x-show="myReviews.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="myReviews.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div x-show="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-6 flex items-center gap-3">
                <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Loading...</span>
            </div>
        </div>
    </div>

    <script>
        function reviewTests() {
            return {
                activeTab: 'product',
                loading: false,

                product: {
                    id: '',
                    reviews: null,
                    summary: null,
                    response: null
                },

                submit: {
                    productId: '',
                    nickname: '',
                    rating: 0,
                    title: '',
                    detail: '',
                    result: false,
                    success: false,
                    message: '',
                    response: null
                },

                myReviews: {
                    reviews: null,
                    total: 0,
                    response: null
                },

                async loadReviews() {
                    this.loading = true;
                    try {
                        const res = await fetch(`/api/products/${this.product.id}/reviews`);
                        const data = await res.json();
                        this.product.response = JSON.stringify(data, null, 2);
                        this.product.reviews = data.reviews || data.member || data['hydra:member'] || data.items || data;
                        this.product.summary = data.summary || {
                            averageRating: data.averageRating,
                            totalReviews: data.totalItems || data['hydra:totalItems'] || this.product.reviews?.length || 0,
                            ratingBreakdown: data.ratingBreakdown
                        };
                    } catch (e) {
                        this.product.response = 'Error: ' + e.message;
                    }
                    this.loading = false;
                },

                async submitReview() {
                    this.loading = true;
                    this.submit.result = false;

                    try {
                        const res = await fetch(`/api/products/${this.submit.productId}/reviews`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                nickname: this.submit.nickname,
                                rating: this.submit.rating,
                                title: this.submit.title,
                                detail: this.submit.detail
                            })
                        });
                        const data = await res.json();
                        this.submit.response = JSON.stringify(data, null, 2);
                        this.submit.result = true;
                        this.submit.success = res.ok;
                        this.submit.message = res.ok
                            ? 'Your review has been submitted and is pending approval.'
                            : (data.message || data.error || 'Failed to submit review');
                    } catch (e) {
                        this.submit.response = 'Error: ' + e.message;
                        this.submit.result = true;
                        this.submit.success = false;
                        this.submit.message = e.message;
                    }

                    this.loading = false;
                },

                async loadMyReviews() {
                    this.loading = true;
                    try {
                        const token = localStorage.getItem('authToken');
                        const headers = { 'Content-Type': 'application/json' };
                        if (token) headers['Authorization'] = 'Bearer ' + token;

                        const res = await fetch('/api/customers/me/reviews', { headers });
                        const data = await res.json();
                        this.myReviews.response = JSON.stringify(data, null, 2);
                        this.myReviews.reviews = data.member || data['hydra:member'] || data.items || data;
                        this.myReviews.total = data.totalItems || data['hydra:totalItems'] || this.myReviews.reviews?.length || 0;
                    } catch (e) {
                        this.myReviews.response = 'Error: ' + e.message;
                    }
                    this.loading = false;
                }
            };
        }
    </script>
</body>
</html>
