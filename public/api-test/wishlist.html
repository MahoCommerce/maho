<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wishlist API Tests - Maho API Test Harness</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div x-data="wishlistTests()" class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <a href="index.html" class="text-blue-400 hover:text-blue-300 text-sm">&larr; Back to Dashboard</a>
            <h1 class="text-3xl font-bold text-white mt-2">Wishlist API Tests</h1>
            <p class="text-gray-400">Test customer wishlist endpoints (requires authentication)</p>
        </header>

        <!-- API Endpoints Reference -->
        <div class="bg-gray-800 rounded-lg p-4 mb-8">
            <h2 class="text-lg font-semibold mb-3">API Endpoints</h2>
            <div class="text-sm font-mono text-gray-300">
                <ul class="space-y-1">
                    <li>GET /api/customers/me/wishlist - Get wishlist items</li>
                    <li>POST /api/customers/me/wishlist - Add item to wishlist</li>
                    <li>DELETE /api/customers/me/wishlist/{itemId} - Remove item</li>
                    <li>POST /api/customers/me/wishlist/{itemId}/move-to-cart - Move to cart</li>
                    <li>POST /api/customers/me/wishlist/sync - Sync guest wishlist</li>
                </ul>
            </div>
        </div>

        <!-- Auth Status -->
        <div class="bg-gray-800 rounded-lg p-4 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="w-3 h-3 rounded-full" :class="token ? 'bg-green-500' : 'bg-red-500'"></span>
                    <span x-text="token ? 'Authenticated' : 'Not authenticated'"></span>
                </div>
                <div class="flex gap-2">
                    <input type="text" x-model="tokenInput" placeholder="Paste JWT token..."
                           class="bg-gray-700 rounded px-3 py-1 text-sm w-64">
                    <button @click="setToken()" class="bg-blue-600 hover:bg-blue-700 px-4 py-1 rounded text-sm">Set Token</button>
                    <button @click="clearToken()" class="bg-gray-700 hover:bg-gray-600 px-4 py-1 rounded text-sm">Clear</button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button @click="activeTab = 'list'"
                    :class="activeTab === 'list' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">View Wishlist</button>
            <button @click="activeTab = 'add'"
                    :class="activeTab === 'add' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">Add Item</button>
            <button @click="activeTab = 'sync'"
                    :class="activeTab === 'sync' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">Sync Guest</button>
        </div>

        <!-- View Wishlist Tab -->
        <div x-show="activeTab === 'list'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">My Wishlist</h3>
                    <button @click="loadWishlist()"
                            :disabled="loading || !token"
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Load Wishlist
                    </button>
                </div>

                <div x-show="!token" class="text-yellow-400 text-sm">
                    Please set your JWT token above to access the wishlist.
                </div>
            </div>

            <!-- Wishlist Items -->
            <div x-show="wishlist.items" class="space-y-4">
                <div class="flex items-center justify-between text-gray-400">
                    <span><span class="font-semibold text-white" x-text="wishlist.total"></span> items in wishlist</span>
                    <span class="text-xs" x-text="wishlist.time + 'ms'"></span>
                </div>

                <div x-show="wishlist.items.length === 0" class="bg-gray-800 rounded-lg p-8 text-center text-gray-400">
                    Your wishlist is empty.
                </div>

                <template x-for="item in wishlist.items" :key="item.id">
                    <div class="bg-gray-800 rounded-lg p-4 flex gap-4">
                        <div class="w-20 h-20 bg-gray-900 rounded flex-shrink-0 flex items-center justify-center">
                            <template x-if="item.product?.thumbnailUrl || item.product?.image || item.imageUrl">
                                <img :src="item.product?.thumbnailUrl || item.product?.image || item.imageUrl" class="max-w-full max-h-full object-contain">
                            </template>
                            <template x-if="!item.product?.thumbnailUrl && !item.product?.image && !item.imageUrl">
                                <span class="text-gray-600 text-xs">No img</span>
                            </template>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold" x-text="item.product?.name || item.name"></h4>
                            <p class="text-xs text-gray-500 font-mono" x-text="item.product?.sku || item.sku"></p>
                            <p class="text-green-400 font-semibold mt-1" x-text="'$' + (item.product?.price || item.price || 0).toFixed(2)"></p>
                            <p class="text-xs text-gray-500 mt-1">Added: <span x-text="item.addedAt || item.createdAt || '-'"></span></p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button @click="moveToCart(item.id)"
                                    :disabled="loading"
                                    class="bg-green-600 hover:bg-green-700 disabled:opacity-50 px-4 py-2 rounded text-sm">
                                Move to Cart
                            </button>
                            <button @click="removeItem(item.id)"
                                    :disabled="loading"
                                    class="bg-red-600 hover:bg-red-700 disabled:opacity-50 px-4 py-2 rounded text-sm">
                                Remove
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Raw Response -->
            <div x-show="wishlist.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="wishlist.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- Add Item Tab -->
        <div x-show="activeTab === 'add'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Add Item to Wishlist</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Product ID</label>
                        <input type="text" x-model="add.productId" placeholder="Product ID"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Quantity (optional)</label>
                        <input type="number" x-model="add.qty" placeholder="1" min="1"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">Description (optional)</label>
                    <textarea x-model="add.description" placeholder="Notes about this item..."
                              rows="2" class="w-full bg-gray-700 rounded px-3 py-2"></textarea>
                </div>

                <button @click="addItem()"
                        :disabled="loading || !token || !add.productId"
                        class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                    Add to Wishlist
                </button>
            </div>

            <!-- Add Result -->
            <div x-show="add.result" class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl" x-text="add.success ? '✓' : '✗'"></span>
                    <span class="font-semibold" :class="add.success ? 'text-green-400' : 'text-red-400'"
                          x-text="add.success ? 'Item added to wishlist!' : 'Failed to add item'"></span>
                </div>
                <p class="text-gray-400" x-text="add.message"></p>
            </div>

            <!-- Raw Response -->
            <div x-show="add.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="add.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- Sync Guest Tab -->
        <div x-show="activeTab === 'sync'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Sync Guest Wishlist</h3>
                <p class="text-gray-400 text-sm mb-4">
                    When a guest user logs in, sync their local wishlist (stored in localStorage) with their account.
                </p>

                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">Guest Wishlist Items (JSON array of product IDs)</label>
                    <textarea x-model="sync.items" placeholder='[123, 456, 789]'
                              rows="3" class="w-full bg-gray-700 rounded px-3 py-2 font-mono text-sm"></textarea>
                </div>

                <button @click="syncWishlist()"
                        :disabled="loading || !token || !sync.items"
                        class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                    Sync Wishlist
                </button>
            </div>

            <!-- Sync Result -->
            <div x-show="sync.result" class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl" x-text="sync.success ? '✓' : '✗'"></span>
                    <span class="font-semibold" :class="sync.success ? 'text-green-400' : 'text-red-400'"
                          x-text="sync.success ? 'Wishlist synced!' : 'Sync failed'"></span>
                </div>
                <p class="text-gray-400" x-text="sync.message"></p>
            </div>

            <!-- Raw Response -->
            <div x-show="sync.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="sync.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div x-show="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-6 flex items-center gap-3">
                <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Loading...</span>
            </div>
        </div>
    </div>

    <script>
        function wishlistTests() {
            return {
                activeTab: 'list',
                loading: false,
                token: localStorage.getItem('authToken') || '',
                tokenInput: '',

                wishlist: {
                    items: null,
                    total: 0,
                    time: null,
                    response: null
                },

                add: {
                    productId: '',
                    qty: 1,
                    description: '',
                    result: false,
                    success: false,
                    message: '',
                    response: null
                },

                sync: {
                    items: '',
                    result: false,
                    success: false,
                    message: '',
                    response: null
                },

                setToken() {
                    this.token = this.tokenInput;
                    localStorage.setItem('authToken', this.token);
                    this.tokenInput = '';
                },

                clearToken() {
                    this.token = '';
                    localStorage.removeItem('authToken');
                },

                getHeaders() {
                    return {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    };
                },

                async loadWishlist() {
                    this.loading = true;
                    const start = Date.now();

                    try {
                        const res = await fetch('/api/customers/me/wishlist', {
                            headers: this.getHeaders()
                        });
                        const data = await res.json();
                        this.wishlist.time = Date.now() - start;
                        this.wishlist.response = JSON.stringify(data, null, 2);
                        this.wishlist.items = data.items || data.member || data['hydra:member'] || data;
                        this.wishlist.total = data.totalItems || data['hydra:totalItems'] || this.wishlist.items?.length || 0;
                    } catch (e) {
                        this.wishlist.time = Date.now() - start;
                        this.wishlist.response = 'Error: ' + e.message;
                    }

                    this.loading = false;
                },

                async addItem() {
                    this.loading = true;
                    this.add.result = false;

                    try {
                        const res = await fetch('/api/customers/me/wishlist', {
                            method: 'POST',
                            headers: this.getHeaders(),
                            body: JSON.stringify({
                                productId: this.add.productId,
                                qty: this.add.qty || 1,
                                description: this.add.description || null
                            })
                        });
                        const data = await res.json();
                        this.add.response = JSON.stringify(data, null, 2);
                        this.add.result = true;
                        this.add.success = res.ok;
                        this.add.message = res.ok ? 'Product added to wishlist' : (data.message || data.error || 'Failed to add item');
                    } catch (e) {
                        this.add.response = 'Error: ' + e.message;
                        this.add.result = true;
                        this.add.success = false;
                        this.add.message = e.message;
                    }

                    this.loading = false;
                },

                async removeItem(itemId) {
                    if (!confirm('Remove this item from wishlist?')) return;

                    this.loading = true;
                    try {
                        const res = await fetch(`/api/customers/me/wishlist/${itemId}`, {
                            method: 'DELETE',
                            headers: this.getHeaders()
                        });
                        if (res.ok) {
                            await this.loadWishlist();
                        }
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                    this.loading = false;
                },

                async moveToCart(itemId) {
                    this.loading = true;
                    try {
                        const res = await fetch(`/api/customers/me/wishlist/${itemId}/move-to-cart`, {
                            method: 'POST',
                            headers: this.getHeaders()
                        });
                        const data = await res.json();
                        if (res.ok) {
                            alert('Item moved to cart!');
                            await this.loadWishlist();
                        } else {
                            alert(data.message || data.error || 'Failed to move item');
                        }
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                    this.loading = false;
                },

                async syncWishlist() {
                    this.loading = true;
                    this.sync.result = false;

                    try {
                        let items = [];
                        try {
                            items = JSON.parse(this.sync.items);
                        } catch (e) {
                            throw new Error('Invalid JSON. Enter an array of product IDs.');
                        }

                        const res = await fetch('/api/customers/me/wishlist/sync', {
                            method: 'POST',
                            headers: this.getHeaders(),
                            body: JSON.stringify({ productIds: items })
                        });
                        const data = await res.json();
                        this.sync.response = JSON.stringify(data, null, 2);
                        this.sync.result = true;
                        this.sync.success = res.ok;
                        this.sync.message = res.ok
                            ? `Synced ${data.added || 0} items, ${data.skipped || 0} already existed`
                            : (data.message || data.error || 'Sync failed');
                    } catch (e) {
                        this.sync.response = 'Error: ' + e.message;
                        this.sync.result = true;
                        this.sync.success = false;
                        this.sync.message = e.message;
                    }

                    this.loading = false;
                }
            };
        }
    </script>
</body>
</html>
