<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog API Tests - Maho API Test Harness</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div x-data="blogTests()" class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <a href="index.html" class="text-blue-400 hover:text-blue-300 text-sm">&larr; Back to Dashboard</a>
            <h1 class="text-3xl font-bold text-white mt-2">Blog API Tests</h1>
            <p class="text-gray-400">Test blog posts and articles endpoints</p>
        </header>

        <!-- API Endpoints Reference -->
        <div class="bg-gray-800 rounded-lg p-4 mb-8">
            <h2 class="text-lg font-semibold mb-3">API Endpoints</h2>
            <div class="text-sm font-mono text-gray-300">
                <ul class="space-y-1">
                    <li>GET /api/blog-posts</li>
                    <li>GET /api/blog-posts/{id}</li>
                    <li>GET /api/blog-posts?search=...</li>
                    <li>GET /api/blog-posts?category=...</li>
                </ul>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button @click="activeTab = 'list'"
                    :class="activeTab === 'list' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">List Posts</button>
            <button @click="activeTab = 'detail'"
                    :class="activeTab === 'detail' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">Get Post</button>
            <button @click="activeTab = 'search'"
                    :class="activeTab === 'search' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">Search</button>
        </div>

        <!-- List Posts Tab -->
        <div x-show="activeTab === 'list'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Blog Posts</h3>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Page Size</label>
                        <select x-model="list.pageSize" class="w-full bg-gray-700 rounded px-3 py-2">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Sort By</label>
                        <select x-model="list.sortBy" class="w-full bg-gray-700 rounded px-3 py-2">
                            <option value="created_at">Date Created</option>
                            <option value="title">Title</option>
                            <option value="views">Views</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Order</label>
                        <select x-model="list.sortDir" class="w-full bg-gray-700 rounded px-3 py-2">
                            <option value="desc">Newest First</option>
                            <option value="asc">Oldest First</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button @click="loadPosts()"
                                :disabled="loading"
                                class="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                            Load Posts
                        </button>
                    </div>
                </div>
            </div>

            <!-- Posts Grid -->
            <div x-show="list.results" class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-gray-400">Found</span>
                        <span class="font-semibold" x-text="list.total"></span>
                        <span class="text-gray-400">posts</span>
                        <span class="text-xs text-gray-500 ml-2" x-text="list.time + 'ms'"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="list.page > 1 && (list.page--, loadPosts())"
                                :disabled="list.page <= 1"
                                class="bg-gray-700 hover:bg-gray-600 disabled:opacity-50 px-3 py-1 rounded text-sm">
                            Prev
                        </button>
                        <span class="text-sm">Page <span x-text="list.page"></span></span>
                        <button @click="list.page++; loadPosts()"
                                class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">
                            Next
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <template x-for="post in list.results" :key="post.id">
                        <div class="bg-gray-800 rounded-lg overflow-hidden hover:bg-gray-700 cursor-pointer"
                             @click="viewPost(post.id)">
                            <div x-show="post.image || post.featuredImage" class="aspect-video bg-gray-900">
                                <img :src="post.featuredImage || post.image" class="w-full h-full object-cover">
                            </div>
                            <div class="p-4">
                                <h4 class="font-semibold mb-2" x-text="post.title"></h4>
                                <p class="text-gray-400 text-sm line-clamp-2" x-text="post.shortContent || post.excerpt || ''"></p>
                                <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                                    <span x-text="post.createdAt || post.publishDate || ''"></span>
                                    <span x-show="post.author" x-text="'By ' + (post.author?.name || post.author)"></span>
                                    <span x-show="post.views" x-text="post.views + ' views'"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Raw Response -->
            <div x-show="list.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="list.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- Get Post Tab -->
        <div x-show="activeTab === 'detail'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Get Blog Post</h3>

                <div class="flex gap-2 mb-4">
                    <input type="text" x-model="detail.id" placeholder="Post ID (e.g., 1)"
                           @keyup.enter="getPost()"
                           class="flex-1 bg-gray-700 rounded px-3 py-2">
                    <button @click="getPost()"
                            :disabled="loading || !detail.id"
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Get Post
                    </button>
                </div>
            </div>

            <!-- Post Detail -->
            <div x-show="detail.data" class="bg-gray-800 rounded-lg overflow-hidden">
                <div x-show="detail.data?.featuredImage || detail.data?.image" class="aspect-video bg-gray-900">
                    <img :src="detail.data?.featuredImage || detail.data?.image" class="w-full h-full object-cover">
                </div>
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-2" x-text="detail.data?.title"></h2>
                    <div class="flex items-center gap-4 text-sm text-gray-400 mb-4">
                        <span x-text="detail.data?.createdAt || detail.data?.publishDate"></span>
                        <span x-show="detail.data?.author" x-text="'By ' + (detail.data?.author?.name || detail.data?.author)"></span>
                        <span x-show="detail.data?.category" class="px-2 py-0.5 bg-gray-700 rounded" x-text="detail.data?.category?.name || detail.data?.category"></span>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                        <div><span class="text-gray-400">ID:</span> <span x-text="detail.data?.id"></span></div>
                        <div><span class="text-gray-400">Status:</span>
                            <span class="text-xs px-2 py-0.5 rounded"
                                  :class="detail.data?.isActive !== false ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'"
                                  x-text="detail.data?.isActive !== false ? 'Published' : 'Draft'"></span>
                        </div>
                        <div><span class="text-gray-400">Views:</span> <span x-text="detail.data?.views || 0"></span></div>
                        <div><span class="text-gray-400">URL:</span> <span class="font-mono text-xs" x-text="detail.data?.urlKey || detail.data?.identifier || '-'"></span></div>
                    </div>

                    <div x-show="detail.data?.content" class="prose prose-invert max-w-none">
                        <div x-html="detail.data?.content"></div>
                    </div>

                    <div x-show="detail.data?.tags && detail.data?.tags.length" class="mt-4">
                        <span class="text-gray-400 text-sm">Tags:</span>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <template x-for="tag in detail.data?.tags" :key="tag.id || tag">
                                <span class="text-xs bg-gray-700 px-2 py-1 rounded" x-text="tag.name || tag"></span>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Raw Response -->
            <div x-show="detail.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="detail.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- Search Tab -->
        <div x-show="activeTab === 'search'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Search Posts</h3>

                <div class="flex gap-2 mb-4">
                    <input type="text" x-model="search.query" placeholder="Search posts..."
                           @keyup.enter="searchPosts()"
                           class="flex-1 bg-gray-700 rounded px-3 py-2">
                    <button @click="searchPosts()"
                            :disabled="loading"
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Search
                    </button>
                </div>
            </div>

            <!-- Search Results -->
            <div x-show="search.results" class="bg-gray-800 rounded-lg p-6">
                <div class="mb-4">
                    <span class="text-gray-400">Found</span>
                    <span class="font-semibold" x-text="search.total"></span>
                    <span class="text-gray-400">posts</span>
                </div>

                <div class="space-y-3">
                    <template x-for="post in search.results" :key="post.id">
                        <div class="p-3 bg-gray-900 rounded hover:bg-gray-700 cursor-pointer"
                             @click="viewPost(post.id)">
                            <h4 class="font-medium" x-text="post.title"></h4>
                            <p class="text-gray-400 text-sm" x-text="post.shortContent || post.excerpt || ''"></p>
                            <div class="text-xs text-gray-500 mt-1" x-text="post.createdAt || post.publishDate"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Raw Response -->
            <div x-show="search.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="search.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div x-show="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-6 flex items-center gap-3">
                <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Loading...</span>
            </div>
        </div>
    </div>

    <script>
        function blogTests() {
            return {
                activeTab: 'list',
                loading: false,

                list: {
                    pageSize: '10',
                    page: 1,
                    sortBy: 'created_at',
                    sortDir: 'desc',
                    results: null,
                    total: 0,
                    time: null,
                    response: null
                },

                detail: {
                    id: '',
                    data: null,
                    response: null
                },

                search: {
                    query: '',
                    results: null,
                    total: 0,
                    response: null
                },

                async loadPosts() {
                    this.loading = true;
                    const start = Date.now();

                    try {
                        const params = new URLSearchParams();
                        params.append('pageSize', this.list.pageSize);
                        params.append('page', this.list.page);
                        if (this.list.sortBy) params.append('sortBy', this.list.sortBy);
                        if (this.list.sortDir) params.append('sortDir', this.list.sortDir);

                        const res = await fetch('/api/blog-posts?' + params.toString());
                        const data = await res.json();

                        this.list.time = Date.now() - start;
                        this.list.response = JSON.stringify(data, null, 2);
                        this.list.results = data.member || data['hydra:member'] || data.items || data;
                        this.list.total = data.totalItems || data['hydra:totalItems'] || this.list.results?.length || 0;
                    } catch (e) {
                        this.list.time = Date.now() - start;
                        this.list.response = 'Error: ' + e.message;
                        this.list.results = null;
                    }

                    this.loading = false;
                },

                async getPost() {
                    this.loading = true;
                    try {
                        const res = await fetch(`/api/blog-posts/${this.detail.id}`);
                        const data = await res.json();
                        this.detail.response = JSON.stringify(data, null, 2);
                        this.detail.data = data;
                    } catch (e) {
                        this.detail.response = 'Error: ' + e.message;
                        this.detail.data = null;
                    }
                    this.loading = false;
                },

                viewPost(id) {
                    this.detail.id = String(id);
                    this.activeTab = 'detail';
                    this.getPost();
                },

                async searchPosts() {
                    this.loading = true;
                    try {
                        const params = new URLSearchParams();
                        if (this.search.query) params.append('search', this.search.query);

                        const res = await fetch('/api/blog-posts?' + params.toString());
                        const data = await res.json();
                        this.search.response = JSON.stringify(data, null, 2);
                        this.search.results = data.member || data['hydra:member'] || data.items || data;
                        this.search.total = data.totalItems || data['hydra:totalItems'] || this.search.results?.length || 0;
                    } catch (e) {
                        this.search.response = 'Error: ' + e.message;
                        this.search.results = null;
                    }
                    this.loading = false;
                }
            };
        }
    </script>
</body>
</html>
