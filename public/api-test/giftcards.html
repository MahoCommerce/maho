<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gift Cards API Tests - Maho API Test Harness</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div x-data="giftcardTests()" class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <a href="index.html" class="text-blue-400 hover:text-blue-300 text-sm">&larr; Back to Dashboard</a>
            <h1 class="text-3xl font-bold text-white mt-2">Gift Cards API Tests</h1>
            <p class="text-gray-400">Test gift card balance lookup and redemption</p>
        </header>

        <!-- API Endpoints Reference -->
        <div class="bg-gray-800 rounded-lg p-4 mb-8">
            <h2 class="text-lg font-semibold mb-3">API Endpoints</h2>
            <div class="text-sm font-mono text-gray-300">
                <ul class="space-y-1">
                    <li>GET /api/giftcards/{code} - Check balance</li>
                    <li>PUT /api/guest-carts/{id}/giftcard - Apply to cart</li>
                    <li>DELETE /api/guest-carts/{id}/giftcard - Remove from cart</li>
                </ul>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button @click="activeTab = 'balance'"
                    :class="activeTab === 'balance' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">Check Balance</button>
            <button @click="activeTab = 'apply'"
                    :class="activeTab === 'apply' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium">Apply to Cart</button>
        </div>

        <!-- Check Balance Tab -->
        <div x-show="activeTab === 'balance'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Check Gift Card Balance</h3>

                <div class="flex gap-2 mb-4">
                    <input type="text" x-model="balance.code" placeholder="Gift card code (e.g., GC-123-456-789)"
                           @keyup.enter="checkBalance()"
                           class="flex-1 bg-gray-700 rounded px-3 py-2 font-mono uppercase">
                    <button @click="checkBalance()"
                            :disabled="loading || !balance.code"
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Check Balance
                    </button>
                </div>

                <p class="text-xs text-gray-500">Enter the gift card code to check its current balance and status.</p>
            </div>

            <!-- Balance Result -->
            <div x-show="balance.data" class="bg-gray-800 rounded-lg p-6">
                <div class="text-center mb-6">
                    <div class="text-5xl font-bold text-green-400 mb-2" x-text="'$' + (balance.data?.balance || 0).toFixed(2)"></div>
                    <p class="text-gray-400">Current Balance</p>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="bg-gray-900 rounded p-3">
                        <span class="text-gray-400 block text-xs">Code</span>
                        <span class="font-mono" x-text="balance.data?.code"></span>
                    </div>
                    <div class="bg-gray-900 rounded p-3">
                        <span class="text-gray-400 block text-xs">Status</span>
                        <span class="px-2 py-0.5 rounded text-xs"
                              :class="balance.data?.status === 'active' ? 'bg-green-900 text-green-300' :
                                      balance.data?.status === 'used' ? 'bg-gray-700 text-gray-400' :
                                      'bg-red-900 text-red-300'"
                              x-text="balance.data?.status || 'Unknown'"></span>
                    </div>
                    <div class="bg-gray-900 rounded p-3">
                        <span class="text-gray-400 block text-xs">Initial Value</span>
                        <span x-text="'$' + (balance.data?.initialValue || balance.data?.balance || 0).toFixed(2)"></span>
                    </div>
                    <div class="bg-gray-900 rounded p-3">
                        <span class="text-gray-400 block text-xs">Expires</span>
                        <span x-text="balance.data?.expiresAt || balance.data?.expireDate || 'Never'"></span>
                    </div>
                </div>

                <div x-show="balance.data?.history && balance.data?.history.length" class="mt-6">
                    <h4 class="text-sm font-semibold text-gray-400 mb-2">Transaction History</h4>
                    <div class="space-y-2">
                        <template x-for="tx in balance.data?.history" :key="tx.id || tx.date">
                            <div class="flex items-center justify-between text-sm bg-gray-900 rounded p-2">
                                <span x-text="tx.action || tx.type"></span>
                                <span :class="tx.amount > 0 ? 'text-green-400' : 'text-red-400'"
                                      x-text="(tx.amount > 0 ? '+' : '') + '$' + tx.amount.toFixed(2)"></span>
                                <span class="text-gray-500 text-xs" x-text="tx.date || tx.createdAt"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Error -->
            <div x-show="balance.error" class="bg-red-900/30 border border-red-700 rounded-lg p-6">
                <h3 class="text-red-400 font-semibold mb-2">Gift Card Not Found</h3>
                <p class="text-gray-300" x-text="balance.error"></p>
            </div>

            <!-- Raw Response -->
            <div x-show="balance.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="balance.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- Apply to Cart Tab -->
        <div x-show="activeTab === 'apply'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Apply Gift Card to Cart</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Cart ID</label>
                        <input type="text" x-model="apply.cartId" placeholder="Cart ID"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Gift Card Code</label>
                        <input type="text" x-model="apply.code" placeholder="GC-123-456-789"
                               class="w-full bg-gray-700 rounded px-3 py-2 font-mono uppercase">
                    </div>
                </div>

                <div class="flex gap-2">
                    <button @click="applyGiftcard()"
                            :disabled="loading || !apply.cartId || !apply.code"
                            class="bg-green-600 hover:bg-green-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Apply Gift Card
                    </button>
                    <button @click="removeGiftcard()"
                            :disabled="loading || !apply.cartId"
                            class="bg-red-600 hover:bg-red-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Remove Gift Card
                    </button>
                </div>
            </div>

            <!-- Apply Result -->
            <div x-show="apply.result" class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-2xl" x-text="apply.success ? '✓' : '✗'"></span>
                    <span class="font-semibold" x-text="apply.success ? 'Gift card applied!' : 'Failed to apply'"></span>
                </div>
                <p class="text-gray-400" x-text="apply.message"></p>
            </div>

            <!-- Raw Response -->
            <div x-show="apply.response" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="apply.response"></code></pre>
                </details>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div x-show="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-6 flex items-center gap-3">
                <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Loading...</span>
            </div>
        </div>
    </div>

    <script>
        function giftcardTests() {
            return {
                activeTab: 'balance',
                loading: false,

                balance: {
                    code: '',
                    data: null,
                    error: null,
                    response: null
                },

                apply: {
                    cartId: localStorage.getItem('cartId') || '',
                    code: '',
                    result: false,
                    success: false,
                    message: '',
                    response: null
                },

                async checkBalance() {
                    this.loading = true;
                    this.balance.error = null;
                    this.balance.data = null;

                    try {
                        const res = await fetch(`/api/giftcards/${encodeURIComponent(this.balance.code)}`);
                        const data = await res.json();
                        this.balance.response = JSON.stringify(data, null, 2);

                        if (res.ok) {
                            this.balance.data = data;
                        } else {
                            this.balance.error = data.message || data.error || 'Gift card not found';
                        }
                    } catch (e) {
                        this.balance.response = 'Error: ' + e.message;
                        this.balance.error = e.message;
                    }

                    this.loading = false;
                },

                async applyGiftcard() {
                    this.loading = true;
                    this.apply.result = false;

                    try {
                        const res = await fetch(`/api/guest-carts/${this.apply.cartId}/giftcard`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ giftcardCode: this.apply.code })
                        });
                        const data = await res.json();
                        this.apply.response = JSON.stringify(data, null, 2);
                        this.apply.result = true;
                        this.apply.success = res.ok;
                        this.apply.message = res.ok
                            ? `Gift card applied. Amount: $${(data.giftcardAmount || data.amount || 0).toFixed(2)}`
                            : (data.message || data.error || 'Failed to apply gift card');
                    } catch (e) {
                        this.apply.response = 'Error: ' + e.message;
                        this.apply.result = true;
                        this.apply.success = false;
                        this.apply.message = e.message;
                    }

                    this.loading = false;
                },

                async removeGiftcard() {
                    this.loading = true;
                    this.apply.result = false;

                    try {
                        const res = await fetch(`/api/guest-carts/${this.apply.cartId}/giftcard`, {
                            method: 'DELETE'
                        });
                        const data = await res.json();
                        this.apply.response = JSON.stringify(data, null, 2);
                        this.apply.result = true;
                        this.apply.success = res.ok;
                        this.apply.message = res.ok ? 'Gift card removed from cart' : (data.message || data.error || 'Failed to remove gift card');
                    } catch (e) {
                        this.apply.response = 'Error: ' + e.message;
                        this.apply.result = true;
                        this.apply.success = false;
                        this.apply.message = e.message;
                    }

                    this.loading = false;
                }
            };
        }
    </script>
</body>
</html>
