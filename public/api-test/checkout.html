<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout API Tests - Maho API Test Harness</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div x-data="checkoutTests()" x-init="init()" class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <a href="index.html" class="text-blue-400 hover:text-blue-300 text-sm">&larr; Back to Dashboard</a>
            <h1 class="text-3xl font-bold text-white mt-2">Checkout API Tests</h1>
            <p class="text-gray-400">Test checkout flow - addresses, shipping, payment, and order placement</p>
        </header>

        <!-- Authentication Panel -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div :class="auth.token ? 'bg-green-500' : 'bg-red-500'" class="w-3 h-3 rounded-full"></div>
                    <span class="font-medium" x-text="auth.token ? 'Authenticated' : 'Not Authenticated'"></span>
                    <span x-show="auth.email" class="text-gray-400 text-sm">(<span x-text="auth.email"></span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <button x-show="!auth.token" @click="auth.showLogin = !auth.showLogin"
                            class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-medium">
                        Login
                    </button>
                    <button x-show="auth.token" @click="logout()"
                            class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm font-medium">
                        Logout
                    </button>
                </div>
            </div>

            <!-- Login Form -->
            <div x-show="auth.showLogin && !auth.token" x-transition class="mt-4 pt-4 border-t border-gray-700">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Email</label>
                        <input type="email" x-model="auth.loginEmail" placeholder="customer@example.com"
                               @keyup.enter="login()"
                               class="w-full bg-gray-700 rounded px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Password</label>
                        <input type="password" x-model="auth.loginPassword" placeholder="Password"
                               @keyup.enter="login()"
                               class="w-full bg-gray-700 rounded px-3 py-2 text-sm">
                    </div>
                    <div>
                        <button @click="login()" :disabled="auth.loading"
                                class="bg-green-600 hover:bg-green-700 disabled:bg-gray-600 px-4 py-2 rounded text-sm font-medium w-full">
                            <span x-show="!auth.loading">Login</span>
                            <span x-show="auth.loading">Authenticating...</span>
                        </button>
                    </div>
                </div>
                <div x-show="auth.error" class="mt-3 text-red-400 text-sm" x-text="auth.error"></div>
            </div>

            <!-- Token Info -->
            <details x-show="auth.token" class="mt-4">
                <summary class="text-sm text-gray-500 cursor-pointer">Token Details</summary>
                <div class="mt-2 bg-gray-900 rounded p-3">
                    <code class="text-xs text-green-300 break-all" x-text="auth.token?.substring(0, 50) + '...'"></code>
                </div>
            </details>
        </div>

        <!-- API Endpoints Reference -->
        <div class="bg-gray-800 rounded-lg p-4 mb-8">
            <h2 class="text-lg font-semibold mb-3">Checkout API Endpoints</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm font-mono">
                <div>
                    <span class="text-yellow-400">REST (Guest):</span>
                    <ul class="mt-1 space-y-1 text-gray-300">
                        <li>POST /api/guest-carts/{id}/shipping-methods</li>
                        <li>GET /api/guest-carts/{id}/payment-methods</li>
                        <li>POST /api/guest-carts/{id}/place-order</li>
                        <li>PUT /api/guest-carts/{id}/coupon</li>
                        <li>DELETE /api/guest-carts/{id}/coupon</li>
                    </ul>
                </div>
                <div>
                    <span class="text-green-400">REST (Authenticated):</span>
                    <ul class="mt-1 space-y-1 text-gray-300">
                        <li>GET /api/carts/{id} <span class="text-gray-500">(JWT)</span></li>
                        <li>POST /api/carts/{id}/items <span class="text-gray-500">(JWT)</span></li>
                    </ul>
                    <p class="text-xs text-gray-500 mt-1">Note: Use guest-carts for shipping/checkout</p>
                </div>
                <div>
                    <span class="text-gray-400">Reference Data:</span>
                    <ul class="mt-1 space-y-1 text-gray-300">
                        <li>GET /api/countries</li>
                        <li>GET /api/countries/{code}</li>
                    </ul>
                    <p class="text-xs text-gray-500 mt-1">Regions in available_regions</p>
                </div>
                <div>
                    <span class="text-purple-400">GraphQL Mutations:</span>
                    <ul class="mt-1 space-y-1 text-gray-300">
                        <li>setShippingAddressOnCart</li>
                        <li>setBillingAddressOnCart</li>
                        <li>setShippingMethodOnCart</li>
                        <li>setPaymentMethodOnCart</li>
                        <li>placeOrder</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Feature Status -->
        <div class="bg-gray-800 rounded-lg p-4 mb-8">
            <h2 class="text-lg font-semibold mb-3">Feature Status</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span>Set Shipping Address</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span>Get Shipping Methods</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span>Set Shipping Method</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span>Get Payment Methods</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span>Set Payment Method</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span>Place Order</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span>Apply Coupon</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span>Countries List</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span>Regions List</span>
                </div>
            </div>
        </div>

        <!-- Current Cart Display -->
        <div class="bg-blue-900/30 border border-blue-700 rounded-lg p-3 mb-6">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center gap-2">
                    <span class="text-blue-300 text-sm">Cart ID:</span>
                    <input type="text" x-model="cartId" placeholder="Enter cart ID"
                           class="bg-transparent border-b border-blue-500 text-white font-mono px-1 w-32">
                </div>
                <div class="flex items-center gap-2">
                    <button @click="loadCart()" :disabled="!cartId || loading"
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-3 py-1 rounded text-sm">
                        Load Cart
                    </button>
                    <button x-show="auth.token" @click="loadCustomerCart()" :disabled="loading"
                            class="bg-green-600 hover:bg-green-700 disabled:opacity-50 px-3 py-1 rounded text-sm">
                        Load My Cart
                    </button>
                    <a href="cart.html" class="text-blue-400 hover:text-blue-300 text-sm">Create Cart &rarr;</a>
                </div>
            </div>
            <div x-show="cart.id" class="mt-2 text-sm text-gray-400">
                <span x-show="cart.customerId" class="text-green-400">[Customer Cart]</span>
                <span x-show="!cart.customerId" class="text-yellow-400">[Guest Cart]</span>
                Items: <span x-text="cart.itemsCount || 0"></span> |
                Total: <span class="text-green-400" x-text="'$' + (cart.totals?.grandTotal || 0).toFixed(2)"></span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-gray-700 overflow-x-auto">
            <button @click="activeTab = 'address'"
                    :class="activeTab === 'address' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium whitespace-nowrap">Shipping Address</button>
            <button @click="activeTab = 'shipping'"
                    :class="activeTab === 'shipping' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium whitespace-nowrap">Shipping Methods</button>
            <button @click="activeTab = 'payment'"
                    :class="activeTab === 'payment' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium whitespace-nowrap">Payment</button>
            <button @click="activeTab = 'order'"
                    :class="activeTab === 'order' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium whitespace-nowrap">Place Order</button>
            <button @click="activeTab = 'countries'"
                    :class="activeTab === 'countries' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium whitespace-nowrap">Countries</button>
            <button @click="activeTab = 'graphql'"
                    :class="activeTab === 'graphql' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                    class="px-4 py-2 border-b-2 font-medium whitespace-nowrap">GraphQL</button>
        </div>

        <!-- Shipping Address Tab -->
        <div x-show="activeTab === 'address'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Set Shipping Address</h3>
                <p class="text-gray-400 text-sm mb-4">Set shipping address to get available shipping methods</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">First Name</label>
                        <input type="text" x-model="address.firstName" placeholder="John"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Last Name</label>
                        <input type="text" x-model="address.lastName" placeholder="Doe"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm text-gray-400 mb-1">Street Address</label>
                        <input type="text" x-model="address.street" placeholder="123 Main Street"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">City</label>
                        <input type="text" x-model="address.city" placeholder="Melbourne"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">State/Region</label>
                        <input type="text" x-model="address.region" placeholder="Victoria"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Postcode</label>
                        <input type="text" x-model="address.postcode" placeholder="3000"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Country</label>
                        <select x-model="address.countryId" class="w-full bg-gray-700 rounded px-3 py-2">
                            <option value="AU">Australia</option>
                            <option value="NZ">New Zealand</option>
                            <option value="US">United States</option>
                            <option value="GB">United Kingdom</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Telephone</label>
                        <input type="text" x-model="address.telephone" placeholder="0400000000"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                    </div>
                </div>

                <!-- Quick Fill Buttons -->
                <div class="flex gap-2 flex-wrap mb-4">
                    <span class="text-gray-400 text-sm">Quick fill:</span>
                    <button @click="fillTestAddress('melbourne')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Melbourne</button>
                    <button @click="fillTestAddress('sydney')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Sydney</button>
                    <button @click="fillTestAddress('brisbane')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Brisbane</button>
                </div>

                <button @click="getShippingMethods()"
                        :disabled="loading || !cartId"
                        class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                    Get Shipping Methods with this Address
                </button>
            </div>

            <!-- Response -->
            <div x-show="shippingResponse.data" class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-sm font-medium">Response</span>
                    <span class="text-xs px-2 py-0.5 rounded"
                          :class="shippingResponse.status >= 200 && shippingResponse.status < 300 ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'"
                          x-text="shippingResponse.status"></span>
                    <span class="text-xs text-gray-500" x-text="shippingResponse.time + 'ms'"></span>
                </div>
                <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="JSON.stringify(shippingResponse.data, null, 2)"></code></pre>
            </div>
        </div>

        <!-- Shipping Methods Tab -->
        <div x-show="activeTab === 'shipping'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Available Shipping Methods</h3>

                <div x-show="!shippingMethods.length" class="text-gray-400">
                    No shipping methods loaded. Set a shipping address first.
                </div>

                <div x-show="shippingMethods.length > 0" class="space-y-2">
                    <template x-for="method in shippingMethods" :key="method.code">
                        <div class="flex items-center justify-between p-3 bg-gray-900 rounded cursor-pointer hover:bg-gray-700"
                             :class="selectedShippingMethod === method.code ? 'ring-2 ring-blue-500' : ''"
                             @click="selectedShippingMethod = method.code">
                            <div>
                                <span class="font-medium" x-text="method.title"></span>
                                <span class="text-gray-400 text-sm ml-2" x-text="method.description"></span>
                                <div class="text-xs text-gray-500 font-mono" x-text="method.code"></div>
                            </div>
                            <span class="text-green-400 font-semibold" x-text="'$' + (method.price || 0).toFixed(2)"></span>
                        </div>
                    </template>
                </div>

                <div x-show="selectedShippingMethod" class="mt-4 pt-4 border-t border-gray-700">
                    <p class="text-sm text-gray-400 mb-2">Selected: <span class="text-white font-mono" x-text="selectedShippingMethod"></span></p>
                    <button @click="setShippingMethod()"
                            :disabled="loading || !cartId"
                            class="bg-green-600 hover:bg-green-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Apply Selected Shipping Method
                    </button>
                </div>
            </div>
        </div>

        <!-- Payment Tab -->
        <div x-show="activeTab === 'payment'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Payment Method</h3>
                    <button @click="loadPaymentMethods()"
                            :disabled="loading || !cartId"
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-4 py-2 rounded text-sm font-medium">
                        <span x-show="!paymentMethodsLoaded">Load Payment Methods</span>
                        <span x-show="paymentMethodsLoaded">Refresh</span>
                    </button>
                </div>

                <!-- Not loaded state -->
                <div x-show="!paymentMethodsLoaded && !paymentMethodsError" class="text-gray-400 mb-4">
                    <p x-show="!cartId">Enter a Cart ID and click "Load Payment Methods" to see available options.</p>
                    <p x-show="cartId">Click "Load Payment Methods" to fetch available payment options for this cart.</p>
                </div>

                <!-- Error state -->
                <div x-show="paymentMethodsError" class="bg-red-900/30 border border-red-700 rounded p-3 mb-4">
                    <p class="text-red-300 text-sm" x-text="paymentMethodsError"></p>
                </div>

                <!-- Payment methods list -->
                <div x-show="paymentMethodsLoaded && paymentMethods.length > 0" class="space-y-2 mb-4">
                    <template x-for="method in paymentMethods" :key="method.code">
                        <div class="flex items-center justify-between p-3 bg-gray-900 rounded cursor-pointer hover:bg-gray-700"
                             :class="selectedPaymentMethod === method.code ? 'ring-2 ring-blue-500' : ''"
                             @click="selectedPaymentMethod = method.code">
                            <div class="flex items-center">
                                <input type="radio" :checked="selectedPaymentMethod === method.code" class="mr-3">
                                <div>
                                    <span class="font-medium" x-text="method.title"></span>
                                    <span x-show="method.description" class="text-gray-400 text-sm ml-2" x-text="method.description"></span>
                                    <div class="text-xs text-gray-500 font-mono" x-text="method.code"></div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span x-show="method.isOffline" class="text-xs bg-yellow-900 text-yellow-300 px-2 py-0.5 rounded">Offline</span>
                                <span class="text-xs text-gray-500" x-text="'Sort: ' + method.sortOrder"></span>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- No methods available -->
                <div x-show="paymentMethodsLoaded && paymentMethods.length === 0" class="text-yellow-400 mb-4">
                    No payment methods available for this cart.
                </div>

                <button @click="setPaymentMethod()"
                        :disabled="loading || !cartId || !selectedPaymentMethod"
                        class="bg-green-600 hover:bg-green-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                    Set Payment Method
                </button>
            </div>

            <!-- Coupon Section -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Coupon Code</h3>

                <div class="flex gap-2">
                    <input type="text" x-model="couponCode" placeholder="Enter coupon code"
                           class="flex-1 bg-gray-700 rounded px-3 py-2">
                    <button @click="applyCoupon()"
                            :disabled="loading || !cartId || !couponCode"
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Apply
                    </button>
                    <button @click="removeCoupon()"
                            :disabled="loading || !cartId"
                            class="bg-red-600 hover:bg-red-700 disabled:opacity-50 px-4 py-2 rounded font-medium">
                        Remove
                    </button>
                </div>

                <div x-show="couponResponse.data" class="mt-4">
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-32"><code x-text="JSON.stringify(couponResponse.data, null, 2)"></code></pre>
                </div>
            </div>
        </div>

        <!-- Place Order Tab -->
        <div x-show="activeTab === 'order'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Place Order</h3>

                <div class="bg-yellow-900/30 border border-yellow-700 rounded p-4 mb-4">
                    <p class="text-yellow-300 text-sm">
                        <strong>Warning:</strong> This will create a real order in the database. Only use for testing purposes.
                    </p>
                </div>

                <!-- Order Summary -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-400 mb-2">Customer Email</h4>
                        <input type="email" x-model="guestEmail" :placeholder="auth.email || 'customer@example.com'"
                               class="w-full bg-gray-700 rounded px-3 py-2">
                        <p x-show="auth.token" class="text-xs text-green-400 mt-1">
                            Logged in as <span x-text="auth.email"></span> - email will be used if field is empty
                        </p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-400 mb-2">Order Summary</h4>
                        <div class="bg-gray-900 rounded p-3 text-sm">
                            <div class="flex justify-between mb-1">
                                <span class="text-gray-400">Cart ID:</span>
                                <span x-text="cartId || 'Not set'"></span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span class="text-gray-400">Items:</span>
                                <span x-text="cart.itemsCount || 0"></span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span class="text-gray-400">Shipping:</span>
                                <span x-text="selectedShippingMethod || 'Not selected'"></span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span class="text-gray-400">Payment:</span>
                                <span x-text="selectedPaymentMethod || 'Not selected'"></span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-gray-700 font-semibold">
                                <span>Total:</span>
                                <span class="text-green-400" x-text="'$' + (cart.totals?.grandTotal || 0).toFixed(2)"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address Preview -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-gray-400 mb-2">Shipping Address</h4>
                    <div class="bg-gray-900 rounded p-3 text-sm">
                        <p x-text="address.firstName + ' ' + address.lastName"></p>
                        <p x-text="address.street"></p>
                        <p x-text="address.city + ', ' + address.region + ' ' + address.postcode"></p>
                        <p x-text="address.countryId"></p>
                        <p x-text="address.telephone"></p>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button @click="placeOrder('rest')"
                            :disabled="loading || !cartId"
                            class="bg-green-600 hover:bg-green-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Place Order (REST)
                    </button>
                    <button @click="placeOrder('graphql')"
                            :disabled="loading || !cartId"
                            class="bg-purple-600 hover:bg-purple-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Place Order (GraphQL)
                    </button>
                </div>
            </div>

            <!-- Order Response -->
            <div x-show="orderResponse.data" class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-sm font-medium">Order Response</span>
                    <span class="text-xs px-2 py-0.5 rounded"
                          :class="orderResponse.status >= 200 && orderResponse.status < 300 ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'"
                          x-text="orderResponse.status"></span>
                </div>

                <div x-show="orderResponse.data?.orderId || orderResponse.data?.incrementId" class="mb-4 p-4 bg-green-900/30 border border-green-700 rounded">
                    <p class="text-green-300">
                        Order placed successfully!
                        Order #<span class="font-mono font-bold" x-text="orderResponse.data?.incrementId || orderResponse.data?.orderId"></span>
                    </p>
                </div>

                <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="JSON.stringify(orderResponse.data, null, 2)"></code></pre>
            </div>
        </div>

        <!-- Countries Tab -->
        <div x-show="activeTab === 'countries'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Countries & Regions</h3>

                <div class="flex gap-4 mb-4">
                    <button @click="loadCountries()"
                            :disabled="loading"
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Load Countries
                    </button>
                </div>

                <div x-show="countries.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-400 mb-2">Select Country</h4>
                        <select x-model="selectedCountry" @change="loadRegions()"
                                class="w-full bg-gray-700 rounded px-3 py-2">
                            <option value="">Select a country</option>
                            <template x-for="country in countries" :key="country.id">
                                <option :value="country.id" x-text="country.name + ' (' + country.id + ')'"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-400 mb-2">Regions/States</h4>
                        <div x-show="regions.length > 0" class="bg-gray-900 rounded p-3 max-h-48 overflow-auto">
                            <template x-for="region in regions" :key="region.id || region.code">
                                <div class="text-sm py-1 border-b border-gray-700 last:border-0">
                                    <span x-text="region.name"></span>
                                    <span class="text-gray-500 text-xs ml-2" x-text="'(' + region.code + ')'"></span>
                                </div>
                            </template>
                        </div>
                        <div x-show="regions.length === 0 && selectedCountry" class="text-gray-400 text-sm">
                            No regions/states for this country
                        </div>
                    </div>
                </div>
            </div>

            <!-- Raw Response -->
            <div x-show="countriesResponse.data" class="bg-gray-800 rounded-lg p-6">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-400 mb-2">Raw Response</summary>
                    <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-64"><code x-text="JSON.stringify(countriesResponse.data, null, 2)"></code></pre>
                </details>
            </div>
        </div>

        <!-- GraphQL Tab -->
        <div x-show="activeTab === 'graphql'" class="space-y-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">GraphQL Checkout Mutations</h3>

                <!-- Endpoint Selection -->
                <div class="mb-4 p-3 bg-gray-900 rounded">
                    <label class="block text-sm text-gray-400 mb-2">Endpoint</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" x-model="graphql.endpoint" value="public" class="text-blue-600">
                            <span><code class="text-blue-400">/api/graphql</code></span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" x-model="graphql.endpoint" value="admin" class="text-purple-600">
                            <span><code class="text-purple-400">/admin/graphql/index</code></span>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">Query/Mutation</label>
                    <textarea x-model="graphql.query" rows="12"
                              class="w-full bg-gray-700 rounded px-3 py-2 font-mono text-sm"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">Variables (JSON)</label>
                    <textarea x-model="graphql.variables" rows="4"
                              class="w-full bg-gray-700 rounded px-3 py-2 font-mono text-sm"></textarea>
                </div>

                <div class="flex gap-2 flex-wrap">
                    <button @click="runGraphQL()"
                            :disabled="loading"
                            class="bg-purple-600 hover:bg-purple-700 disabled:opacity-50 px-6 py-2 rounded font-medium">
                        Execute
                    </button>
                    <button @click="loadGraphQLExample('setShippingAddress')"
                            class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm">
                        Set Shipping Address
                    </button>
                    <button @click="loadGraphQLExample('setShippingMethod')"
                            class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm">
                        Set Shipping Method
                    </button>
                    <button @click="loadGraphQLExample('setPaymentMethod')"
                            class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm">
                        Set Payment Method
                    </button>
                    <button @click="loadGraphQLExample('placeOrder')"
                            class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm">
                        Place Order
                    </button>
                </div>
            </div>

            <!-- Response -->
            <div x-show="graphql.response" class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-sm font-medium">Response</span>
                    <span class="text-xs px-2 py-0.5 rounded"
                          :class="graphql.status >= 200 && graphql.status < 300 ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'"
                          x-text="graphql.status"></span>
                    <span class="text-xs text-gray-500" x-text="graphql.time + 'ms'"></span>
                </div>
                <pre class="bg-gray-900 rounded p-3 text-xs overflow-auto max-h-96"><code x-text="graphql.response"></code></pre>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div x-show="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-6 flex items-center gap-3">
                <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Processing...</span>
            </div>
        </div>
    </div>

    <script>
        function checkoutTests() {
            return {
                activeTab: 'address',
                loading: false,
                cartId: localStorage.getItem('cartId') || '',
                cart: {},
                useCustomerCart: false,

                auth: {
                    token: null,
                    email: null,
                    showLogin: false,
                    loading: false,
                    error: null,
                    loginEmail: '',
                    loginPassword: ''
                },

                address: {
                    firstName: '',
                    lastName: '',
                    street: '',
                    city: '',
                    region: '',
                    postcode: '',
                    countryId: 'AU',
                    telephone: ''
                },

                shippingMethods: [],
                selectedShippingMethod: '',
                shippingResponse: { data: null, status: null, time: null },

                paymentMethods: [],
                paymentMethodsLoaded: false,
                paymentMethodsError: null,
                selectedPaymentMethod: '',

                couponCode: '',
                couponResponse: { data: null },

                guestEmail: '',
                orderResponse: { data: null, status: null },

                countries: [],
                regions: [],
                selectedCountry: '',
                countriesResponse: { data: null },

                graphql: {
                    endpoint: 'admin',
                    query: '',
                    variables: '{}',
                    response: null,
                    status: null,
                    time: null
                },

                init() {
                    // Load auth from localStorage
                    const stored = localStorage.getItem('maho_api_auth');
                    if (stored) {
                        try {
                            const data = JSON.parse(stored);
                            this.auth.token = data.token;
                            this.auth.email = data.email;
                        } catch (e) {}
                    }

                    // Auto-fill test address
                    this.fillTestAddress('melbourne');
                },

                async login() {
                    this.auth.loading = true;
                    this.auth.error = null;

                    try {
                        const res = await fetch('/api/auth/token', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: this.auth.loginEmail,
                                password: this.auth.loginPassword
                            })
                        });

                        const data = await res.json();

                        if (res.ok && data.token) {
                            this.auth.token = data.token;
                            this.auth.email = this.auth.loginEmail;
                            this.auth.showLogin = false;

                            localStorage.setItem('maho_api_auth', JSON.stringify({
                                token: data.token,
                                email: this.auth.loginEmail
                            }));
                            localStorage.setItem('authToken', data.token);
                        } else {
                            this.auth.error = data.message || data.error || 'Authentication failed';
                        }
                    } catch (e) {
                        this.auth.error = 'Network error: ' + e.message;
                    }

                    this.auth.loading = false;
                },

                logout() {
                    this.auth.token = null;
                    this.auth.email = null;
                    localStorage.removeItem('maho_api_auth');
                    localStorage.removeItem('authToken');
                },

                fillTestAddress(city) {
                    const addresses = {
                        melbourne: {
                            firstName: 'Test',
                            lastName: 'Customer',
                            street: '123 Collins Street',
                            city: 'Melbourne',
                            region: 'Victoria',
                            postcode: '3000',
                            countryId: 'AU',
                            telephone: '0400000000'
                        },
                        sydney: {
                            firstName: 'Test',
                            lastName: 'Customer',
                            street: '456 George Street',
                            city: 'Sydney',
                            region: 'New South Wales',
                            postcode: '2000',
                            countryId: 'AU',
                            telephone: '0400000001'
                        },
                        brisbane: {
                            firstName: 'Test',
                            lastName: 'Customer',
                            street: '789 Queen Street',
                            city: 'Brisbane',
                            region: 'Queensland',
                            postcode: '4000',
                            countryId: 'AU',
                            telephone: '0400000002'
                        }
                    };
                    Object.assign(this.address, addresses[city] || addresses.melbourne);
                },

                async loadCart() {
                    if (!this.cartId) return;

                    this.loading = true;
                    try {
                        // Always use guest-carts endpoint - works for any cart by ID
                        const res = await fetch(`/api/guest-carts/${this.cartId}`);

                        if (!res.ok) {
                            const error = await res.json().catch(() => ({ error: 'Cart not found' }));
                            this.cart = {};
                            alert(error.message || error.error || 'Failed to load cart');
                            return;
                        }

                        this.cart = await res.json();
                        localStorage.setItem('cartId', this.cartId);
                    } catch (e) {
                        console.error('Failed to load cart:', e);
                        this.cart = {};
                    } finally {
                        this.loading = false;
                    }
                },

                async loadCustomerCart() {
                    if (!this.auth.token) {
                        alert('Please login first');
                        return;
                    }

                    this.loading = true;
                    try {
                        // Use GraphQL to get customer's active cart
                        const res = await fetch('/admin/graphql/index', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                query: `query { customerCart { id customerId itemsCount itemsQty prices { subtotal grandTotal } items { id sku name qty price rowTotal } } }`
                            })
                        });

                        const result = await res.json();
                        if (result.data?.customerCart) {
                            this.cart = result.data.customerCart;
                            this.cart.totals = result.data.customerCart.prices;
                            this.cartId = String(result.data.customerCart.id);
                            this.useCustomerCart = true;
                            localStorage.setItem('cartId', this.cartId);
                        } else {
                            alert('No active cart found for this customer');
                        }
                    } catch (e) {
                        console.error('Failed to load customer cart:', e);
                        alert('Failed to load customer cart: ' + e.message);
                    }
                    this.loading = false;
                },

                async getShippingMethods() {
                    if (!this.cartId) {
                        alert('Please enter a Cart ID first');
                        return;
                    }

                    this.loading = true;
                    const start = Date.now();

                    try {
                        // Always use guest-carts endpoint - works for both guest and customer carts
                        const endpoint = `/api/guest-carts/${this.cartId}/shipping-methods`;

                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ address: this.address })
                        });

                        // Check if response is JSON before parsing
                        const contentType = res.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            throw new Error(`Server returned ${res.status}: Expected JSON but got ${contentType || 'unknown'}`);
                        }

                        const data = await res.json();

                        this.shippingResponse = {
                            data,
                            status: res.status,
                            time: Date.now() - start
                        };

                        if (Array.isArray(data)) {
                            this.shippingMethods = data;
                            if (data.length > 0 && !this.selectedShippingMethod) {
                                this.selectedShippingMethod = data[0].code;
                            }
                        }
                    } catch (e) {
                        this.shippingResponse = {
                            data: { error: e.message },
                            status: 0,
                            time: Date.now() - start
                        };
                    }

                    this.loading = false;
                },

                async setShippingMethod() {
                    // For REST, shipping method is set during place-order
                    // This would use GraphQL mutation for immediate setting
                    alert('Shipping method will be applied when placing order.\n\nTo set immediately, use the GraphQL mutation.');
                },

                async setPaymentMethod() {
                    // For REST, payment method is set during place-order
                    alert('Payment method will be applied when placing order.\n\nTo set immediately, use the GraphQL mutation.');
                },

                async applyCoupon() {
                    if (!this.cartId || !this.couponCode) return;

                    this.loading = true;
                    try {
                        const res = await fetch(`/api/guest-carts/${this.cartId}/coupon`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ couponCode: this.couponCode })
                        });

                        this.couponResponse.data = await res.json();
                        if (res.ok) {
                            await this.loadCart();
                        }
                    } catch (e) {
                        this.couponResponse.data = { error: e.message };
                    }
                    this.loading = false;
                },

                async removeCoupon() {
                    if (!this.cartId) return;

                    this.loading = true;
                    try {
                        const res = await fetch(`/api/guest-carts/${this.cartId}/coupon`, {
                            method: 'DELETE'
                        });

                        this.couponResponse.data = await res.json();
                        await this.loadCart();
                    } catch (e) {
                        this.couponResponse.data = { error: e.message };
                    }
                    this.loading = false;
                },

                async placeOrder(method) {
                    if (!this.cartId) {
                        alert('Please enter a cart ID');
                        return;
                    }

                    if (!confirm('This will create a real order. Continue?')) {
                        return;
                    }

                    this.loading = true;

                    try {
                        if (method === 'rest') {
                            // Always use guest-carts endpoint - works for both
                            const endpoint = `/api/guest-carts/${this.cartId}/place-order`;

                            const body = {
                                email: this.guestEmail || this.auth.email || 'test@example.com',
                                shippingAddress: this.address,
                                billingAddress: this.address,
                                shippingMethod: this.selectedShippingMethod,
                                paymentMethod: this.selectedPaymentMethod
                            };

                            const res = await fetch(endpoint, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(body)
                            });

                            // Check if response is JSON
                            const contentType = res.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                throw new Error(`Server returned ${res.status}: Expected JSON`);
                            }

                            this.orderResponse = {
                                data: await res.json(),
                                status: res.status
                            };
                        } else {
                            // GraphQL place order
                            const mutation = `
                                mutation PlaceOrder($cartId: ID!) {
                                    placeOrder(cartId: $cartId) {
                                        orderId
                                        incrementId
                                        status
                                        grandTotal
                                    }
                                }
                            `;

                            const res = await fetch('/admin/graphql/index', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    query: mutation,
                                    variables: { cartId: this.cartId }
                                })
                            });

                            const result = await res.json();
                            this.orderResponse = {
                                data: result.data?.placeOrder || result,
                                status: res.status
                            };
                        }
                    } catch (e) {
                        this.orderResponse = {
                            data: { error: e.message },
                            status: 0
                        };
                    }

                    this.loading = false;
                },

                async loadCountries() {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/countries');
                        const data = await res.json();

                        this.countriesResponse.data = data;
                        this.countries = data.member || data || [];
                    } catch (e) {
                        this.countriesResponse.data = { error: e.message };
                    }
                    this.loading = false;
                },

                async loadRegions() {
                    if (!this.selectedCountry) {
                        this.regions = [];
                        return;
                    }

                    this.loading = true;
                    try {
                        // Regions are nested inside the country response as available_regions
                        const res = await fetch(`/api/countries/${this.selectedCountry}`);
                        const data = await res.json();

                        // Extract regions from country response
                        this.regions = data.available_regions || data.regions || [];
                    } catch (e) {
                        console.error('Failed to load regions:', e);
                        this.regions = [];
                    }
                    this.loading = false;
                },

                async loadPaymentMethods() {
                    if (!this.cartId) {
                        alert('Please enter a Cart ID first');
                        return;
                    }

                    this.loading = true;
                    this.paymentMethodsError = null;

                    try {
                        const res = await fetch(`/api/guest-carts/${this.cartId}/payment-methods`);

                        // Check if response is JSON
                        const contentType = res.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            throw new Error(`Server returned ${res.status}: Expected JSON but got ${contentType || 'unknown'}`);
                        }

                        if (!res.ok) {
                            const error = await res.json();
                            throw new Error(error.message || error.error || `HTTP ${res.status}`);
                        }

                        const data = await res.json();
                        this.paymentMethods = data;
                        this.paymentMethodsLoaded = true;

                        // Auto-select first method if none selected
                        if (data.length > 0 && !this.selectedPaymentMethod) {
                            this.selectedPaymentMethod = data[0].code;
                        }
                    } catch (e) {
                        console.error('Failed to load payment methods:', e);
                        this.paymentMethodsError = e.message;
                        this.paymentMethods = [];
                    }

                    this.loading = false;
                },

                loadGraphQLExample(type) {
                    const cartId = this.cartId || '123456';

                    const examples = {
                        setShippingAddress: {
                            query: `mutation SetShippingAddress($cartId: ID!, $address: AddressInput!) {
    setShippingAddressOnCart(cartId: $cartId, address: $address) {
        id
        shippingAddress {
            firstName
            lastName
            street
            city
            region
            postcode
            countryId
        }
        availableShippingMethods {
            carrierCode
            methodCode
            carrierTitle
            methodTitle
            price
        }
    }
}`,
                            variables: JSON.stringify({
                                cartId: cartId,
                                address: this.address
                            }, null, 2)
                        },
                        setShippingMethod: {
                            query: `mutation SetShippingMethod($cartId: ID!, $carrierCode: String!, $methodCode: String!) {
    setShippingMethodOnCart(cartId: $cartId, carrierCode: $carrierCode, methodCode: $methodCode) {
        id
        selectedShippingMethod {
            carrierCode
            methodCode
            price
        }
        prices {
            subtotal
            shippingAmount
            grandTotal
        }
    }
}`,
                            variables: JSON.stringify({
                                cartId: cartId,
                                carrierCode: 'flatrate',
                                methodCode: 'flatrate'
                            }, null, 2)
                        },
                        setPaymentMethod: {
                            query: `mutation SetPaymentMethod($cartId: ID!, $paymentMethod: String!) {
    setPaymentMethodOnCart(cartId: $cartId, paymentMethod: $paymentMethod) {
        id
        selectedPaymentMethod {
            code
            title
        }
    }
}`,
                            variables: JSON.stringify({
                                cartId: cartId,
                                paymentMethod: this.selectedPaymentMethod
                            }, null, 2)
                        },
                        placeOrder: {
                            query: `mutation PlaceOrder($cartId: ID!) {
    placeOrder(cartId: $cartId) {
        orderId
        incrementId
        status
        grandTotal
        invoice {
            invoiceId
            incrementId
        }
        shipment {
            shipmentId
            incrementId
        }
    }
}`,
                            variables: JSON.stringify({
                                cartId: cartId
                            }, null, 2)
                        }
                    };

                    if (examples[type]) {
                        this.graphql.query = examples[type].query;
                        this.graphql.variables = examples[type].variables;
                    }
                },

                async runGraphQL() {
                    this.loading = true;
                    const start = Date.now();

                    try {
                        let variables = {};
                        try {
                            variables = JSON.parse(this.graphql.variables || '{}');
                        } catch (e) {}

                        const url = this.graphql.endpoint === 'public' ? '/api/graphql' : '/admin/graphql/index';
                        const headers = { 'Content-Type': 'application/json' };

                        if (this.graphql.endpoint === 'public' && this.auth.token) {
                            headers['Authorization'] = 'Bearer ' + this.auth.token;
                        }

                        const res = await fetch(url, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify({
                                query: this.graphql.query,
                                variables
                            })
                        });

                        const data = await res.json();

                        this.graphql.status = res.status;
                        this.graphql.time = Date.now() - start;
                        this.graphql.response = JSON.stringify(data, null, 2);
                    } catch (e) {
                        this.graphql.status = 0;
                        this.graphql.time = Date.now() - start;
                        this.graphql.response = 'Error: ' + e.message;
                    }

                    this.loading = false;
                }
            };
        }
    </script>
</body>
</html>
